<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>BSP430: FatFs on an EXP430F5529</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSP430
   &#160;<span id="projectnumber">20141115</span>
   </div>
   <div id="projectbrief">Board Support Package for MSP430 microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">FatFs on an EXP430F5529 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="http://elm-chan.org/fsw/ff/00index_e.html">FatFs</a> is a very nice FAT file system implementation suitable for SD cards and external memory.</p>
<p>The <a href="http://www.ti.com/tool/msp-exp430f5529">MSP-EXP430F5529</a> happens to have a micro SD card peripheral.</p>
<p>The bridge is in the <code>bsp430mmc.c</code> file, which is a lightly modified version of the generic example that came with the FatFs sample package before sometime in 2013 when it was removed (post R0.09b).</p>
<p>This has been tested with R0.09 and R0.10 versions of FatFS. By default it will expect R0.10, which includes an API change. If you are using an older release (e.g. R0.09b) you need to tell the source code, because there's no usable information in the FatFS headers. Add <code>EXT_CPPFLAGS=-DFATFS_IS_PRE_R0_10=1</code> to the <code>make</code> command line.</p>
<h1><a class="anchor" id="ex_platform_exp430f5529_fatfs_bsp430mmc"></a>
bsp430mmc.c</h1>
<p>Only the BSP430-specific elements of this file are extracted here. The first block is the initialization code: </p><div class="fragment"><div class="line"></div>
<div class="line"><span class="comment">/* Include BSP430 material first, which will include msp430.h. */</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="serial_8h.html">bsp430/serial.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="clock_8h.html">bsp430/clock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="port_8h.html">bsp430/periph/port.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="console_8h.html">bsp430/utility/console.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef BSP430_MMC_FAST_HZ</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define BSP430_MMC_FAST_HZ 8000000UL</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MMC_FAST_HZ */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Wrapper to ensure FATFS_IS_PRE_R0_10 is defined.  This supports an</span></div>
<div class="line"><span class="comment"> * API change at R0.10. */</span></div>
<div class="line"><span class="preprocessor">#include &quot;ff_compat.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;diskio.h&quot;</span>     <span class="comment">/* Common include file for FatFs and disk I/O layer */</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* FatFS R0.10a removed these defines. */</span></div>
<div class="line"><span class="preprocessor">#ifndef CT_MMC</span></div>
<div class="line"><span class="comment">/* MMC card type flags (MMC_GET_TYPE) */</span></div>
<div class="line"><span class="preprocessor">#define CT_MMC      0x01        </span><span class="comment">/* MMC ver 3 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CT_SD1      0x02        </span><span class="comment">/* SD ver 1 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CT_SD2      0x04        </span><span class="comment">/* SD ver 2 */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CT_SDC      (CT_SD1|CT_SD2) </span><span class="comment">/* SD */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CT_BLOCK    0x08        </span><span class="comment">/* Block addressing */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CT_MMC */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="comment">/*-------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/* Platform dependent macros and functions needed to be modified           */</span></div>
<div class="line"><span class="comment">/*-------------------------------------------------------------------------*/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define APP_SD_CS_PORT_HPL xBSP430hplLookupPORT(APP_SD_CS_PORT_PERIPH_HANDLE)</span></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430halSERIAL.html">hBSP430halSERIAL</a> sdspi;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* Following BSP430/POSIX conventions, this returns 0 if successful,</span></div>
<div class="line"><span class="comment"> * -1 on error. */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">configureSPIforSD (<span class="keywordtype">int</span> fastp)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> init_spi_divisor;</div>
<div class="line">  <span class="keyword">volatile</span> <a class="code" href="structsBSP430hplPORT__8.html">sBSP430hplPORT</a> * miso_port = <a class="code" href="port_8h.html#af85295c41d6419afb9df641ae90d0213">xBSP430hplLookupPORT</a>(APP_SD_MISO_PORT_PERIPH_HANDLE);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* We&#39;ll drive the SPI device using SMCLK.  For initialization, we</span></div>
<div class="line"><span class="comment">   * need to stay below 400 kHz, and have chosen 380 kHz in case of</span></div>
<div class="line"><span class="comment">   * clock variances.  After initialization, we can go faster. */</span></div>
<div class="line">  <span class="keywordflow">if</span> (fastp) {</div>
<div class="line">    init_spi_divisor = <a class="code" href="serial_8h.html#a55ba4b6d332a2ea1a0c0c077b169bacc">uiBSP430serialSMCLKPrescaler</a>(BSP430_MMC_FAST_HZ);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    init_spi_divisor = <a class="code" href="serial_8h.html#a55ba4b6d332a2ea1a0c0c077b169bacc">uiBSP430serialSMCLKPrescaler</a>(380000UL);</div>
<div class="line">  }</div>
<div class="line">  <span class="comment">/* SPI divisor must not be zero */</span></div>
<div class="line">  <span class="keywordflow">if</span> (0 == init_spi_divisor) {</div>
<div class="line">    init_spi_divisor = 1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Close the device if we already opened it. */</span></div>
<div class="line">  <span class="keywordflow">if</span> (sdspi) {</div>
<div class="line">    (void)<a class="code" href="serial_8h.html#a9ef360a3a47ffaef50409a14fbffe5d2">iBSP430serialClose</a>(sdspi);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* For some SD cards, need MISO pullup, or so we&#39;re told.  Do that</span></div>
<div class="line"><span class="comment">   * first, hoping the platform peripheral configuration won&#39;t destroy</span></div>
<div class="line"><span class="comment">   * it. */</span></div>
<div class="line">  miso_port-&gt;dir &amp;= ~APP_SD_MISO_PORT_BIT;</div>
<div class="line">  <a class="code" href="port_8h.html#a426b86fcf460a8ec570ef5da28765d73">BSP430_PORT_HPL_SET_REN</a>(miso_port, APP_SD_MISO_PORT_BIT, <a class="code" href="port_8h.html#a4b3f157ccdaca9afd0972de8b6bc9ba2">BSP430_PORT_REN_PULL_UP</a>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Configure SPI.  Probably ought to have a way to return an error</span></div>
<div class="line"><span class="comment">   * code.  Note: Per http://elm-chan.org/docs/mmc/mmc_e.html use SPI</span></div>
<div class="line"><span class="comment">   * mode 0 (CPOL=CPHA=0 via UCCKPH). */</span></div>
<div class="line">  sdspi = <a class="code" href="serial_8h.html#a40983f5ed625fd352698117786691dd5">hBSP430serialOpenSPI</a>(<a class="code" href="serial_8h.html#ad311104b2da6d177b2ae5ec0b29e7207">hBSP430serialLookup</a>(APP_SD_SPI_PERIPH_HANDLE),</div>
<div class="line">                               <a class="code" href="serial_8h.html#a84cdc2d11d71d5fd97b96f427c239cb9">BSP430_SERIAL_ADJUST_CTL0_INITIALIZER</a>(<a class="code" href="msp430_8h.html#a51ab25e3e65cd1bb9863b0e6d0b7b6bd">UCCKPH</a> | <a class="code" href="msp430_8h.html#a199ca0dc5cd21e551af5c23d9beec934">UCMSB</a> | <a class="code" href="msp430_8h.html#a83010f7d75e7283b79244ce5a4fa7870">UCMST</a> | <a class="code" href="msp430_8h.html#a2f02e983d228152bb8491fb6cb0f1228">UCMODE_0</a>),</div>
<div class="line">                               UCSSEL__SMCLK, init_spi_divisor);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Configure the chip-select port. */</span></div>
<div class="line">  APP_SD_CS_PORT_HPL-&gt;sel &amp;= ~APP_SD_CS_PORT_BIT;</div>
<div class="line">  APP_SD_CS_PORT_HPL-&gt;out |= APP_SD_CS_PORT_BIT;</div>
<div class="line">  APP_SD_CS_PORT_HPL-&gt;dir |= APP_SD_CS_PORT_BIT;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> (0 != sdspi) ? 0 : -1;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define INIT_PORT() configureSPIforSD(0)</span></div>
<div class="line"><span class="preprocessor">#define REINIT_PORT_FAST() configureSPIforSD(1)</span></div>
<div class="line"><span class="preprocessor">#define DLY_US(n_) BSP430_CORE_DELAY_CYCLES(((n_) * BSP430_CLOCK_NOMINAL_MCLK_HZ)/1000000)</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CS_H() do { APP_SD_CS_PORT_HPL-&gt;out |= APP_SD_CS_PORT_BIT; } while (0)</span></div>
<div class="line"><span class="preprocessor">#define CS_L() do { APP_SD_CS_PORT_HPL-&gt;out &amp;= ~APP_SD_CS_PORT_BIT; } while (0)</span></div>
<div class="line"></div>
</div><!-- fragment --><p> The second block is the SPI transmit/receive infrastructure: </p><div class="fragment"><div class="line"></div>
<div class="line"><span class="comment">/*-----------------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/* Transmit bytes to the card (bitbanging)                               */</span></div>
<div class="line"><span class="comment">/*-----------------------------------------------------------------------*/</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span></div>
<div class="line"><span class="keywordtype">void</span> xmit_mmc (</div>
<div class="line">    <span class="keyword">const</span> BYTE* buff,   <span class="comment">/* Data to be sent */</span></div>
<div class="line">    UINT bc             <span class="comment">/* Number of bytes to send */</span></div>
<div class="line">)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  (void)<a class="code" href="serial_8h.html#a7646c9d6044dcc9729b72cf9e559fa55">iBSP430spiTxRx_rh</a>(sdspi, buff, bc, 0, 0);</div>
<div class="line">  <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">/*-----------------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/* Receive bytes from the card (bitbanging)                              */</span></div>
<div class="line"><span class="comment">/*-----------------------------------------------------------------------*/</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span></div>
<div class="line"><span class="keywordtype">void</span> rcvr_mmc (</div>
<div class="line">    BYTE *buff, <span class="comment">/* Pointer to read buffer */</span></div>
<div class="line">    UINT bc     <span class="comment">/* Number of bytes to receive */</span></div>
<div class="line">)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  (void)<a class="code" href="serial_8h.html#a7646c9d6044dcc9729b72cf9e559fa55">iBSP430spiTxRx_rh</a>(sdspi, NULL, 0, bc, buff);</div>
<div class="line">  <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --><p> There are a couple other enhancements to detect when the SPI interface configuration failed, but otherwise the driver is unmodified from ChaN's generic one.</p>
<h1><a class="anchor" id="ex_platform_exp430f5529_fatfs_main"></a>
main.c</h1>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html">bsp430/platform.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="clock_8h.html">bsp430/clock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="uptime_8h.html">bsp430/utility/uptime.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="console_8h.html">bsp430/utility/console.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="serial_8h.html">bsp430/serial.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="port_8h.html">bsp430/periph/port.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sys_8h.html">bsp430/periph/sys.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pmm_8h.html">bsp430/periph/pmm.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* msp430.h headers define DIR which will conflict with the structure</span></div>
<div class="line"><span class="comment"> * definition from FatFS. */</span></div>
<div class="line"><span class="preprocessor">#undef DIR</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;diskio.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ff.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Get definitions for FATFS_IS_PRE_R0_10 and other flags that</span></div>
<div class="line"><span class="comment"> * accommodate API changes. */</span></div>
<div class="line"><span class="preprocessor">#include &quot;ff_compat.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">char</span> buffer[1024];</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> main ()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> reset_flags;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> reset_causes;</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  FATFS fso;</div>
<div class="line">  DIR dir_obj;</div>
<div class="line">  FILINFO finfo;</div>
<div class="line"></div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sysrstiv;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Record all the reset causes */</span></div>
<div class="line">    reset_causes = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (0 != ((sysrstiv = <a class="code" href="sys_8h.html#a49bc446977f788990eaf4de3e3b3d234">uiBSP430sysSYSRSTGenerator_ni</a>(&amp;reset_flags)))) {</div>
<div class="line">      reset_causes |= 1UL &lt;&lt; (sysrstiv / 2);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="platform_8h.html#a616515ce5e0f7635ca36a815841d2a21">vBSP430platformInitialize_ni</a>();</div>
<div class="line">  (void)<a class="code" href="console_8h.html#a91f5f68fa2ee29ca39bf9a23ea98cbe1">iBSP430consoleInitialize</a>();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\nBUILD &quot;</span> __DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;FatFS Revision ID: %lu\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)_FATFS);</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;System reset bitmask %lx; causes:\n&quot;</span>, reset_causes);</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">int</span> bit = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (bit &lt; (8 * <span class="keyword">sizeof</span>(reset_causes))) {</div>
<div class="line">      <span class="keywordflow">if</span> (reset_causes &amp; (1UL &lt;&lt; bit)) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t%s\n&quot;</span>, <a class="code" href="sys_8h.html#a2012d634fbc0045a010a2158b37248f2">xBSP430sysSYSRSTIVDescription</a>(2*bit));</div>
<div class="line">      }</div>
<div class="line">      ++bit;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot;System reset included:&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_BOR) {</div>
<div class="line">    <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot; BOR&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_LPM5WU) {</div>
<div class="line">    <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot; LPM5WU&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_POR) {</div>
<div class="line">    <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot; POR&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_PUC) {</div>
<div class="line">    <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot; PUC&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line"></div>
<div class="line">  rv = <a class="code" href="pmm_8h.html#ac3621d45ad0e516384a5dce097dadba9">iBSP430pmmSetCoreVoltageLevel_ni</a>(PMMCOREV_3);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Set core voltage gets %d\n&quot;</span>, rv);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (FATFS_IS_PRE_R0_10 - 0)</span></div>
<div class="line">  rv = f_mount(0, &amp;fso);</div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* Pre R0.10 */</span><span class="preprocessor"></span></div>
<div class="line">  rv = f_mount(&amp;fso, <span class="stringliteral">&quot;&quot;</span>, 1);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* Pre R0.10 */</span><span class="preprocessor"></span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;mount gets %d\n&quot;</span>, rv);</div>
<div class="line">  <span class="keywordflow">if</span> (FR_OK == rv) {</div>
<div class="line">    rv = f_opendir(&amp;dir_obj, <span class="stringliteral">&quot;/&quot;</span>);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;opendir gets %d\n&quot;</span>, rv);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">while</span> (FR_OK == rv) {</div>
<div class="line">    rv = f_readdir(&amp;dir_obj, &amp;finfo);</div>
<div class="line">    <span class="keywordflow">if</span> (FR_OK != rv) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (0 == finfo.fname[0]) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%s %lu %u %u %#x\n&quot;</span>, finfo.fname, finfo.fsize, finfo.fdate, finfo.ftime, finfo.fattrib);</div>
<div class="line">  }</div>
<div class="line">  {</div>
<div class="line">    FIL fil_obj;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Append a boot log message to the file BOOT.LOG.  NB: This had</span></div>
<div class="line"><span class="comment">     * failed with version combinations prior to FatFs 0.9b and BSP430</span></div>
<div class="line"><span class="comment">     * 20130427. */</span></div>
<div class="line">    rv = f_open(&amp;fil_obj, <span class="stringliteral">&quot;0:BOOT.LOG&quot;</span>, FA_OPEN_ALWAYS | FA_READ | FA_WRITE);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Boot log open returned %d\n&quot;</span>, rv);</div>
<div class="line">    <span class="keywordflow">if</span> (FR_OK == rv) {</div>
<div class="line">      UINT nbytes = -1;</div>
<div class="line">      rv = f_read(&amp;fil_obj, buffer, <span class="keyword">sizeof</span>(buffer), &amp;nbytes);</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Read boot log %u got %d with %u read\n&quot;</span>,</div>
<div class="line">              (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(buffer), rv, nbytes);</div>
<div class="line">      <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">        buffer[nbytes] = 0;</div>
<div class="line">        <a class="code" href="console_8h.html#a6e0a771b0a8f2034a7f49684b107542e">cputs</a>(<span class="stringliteral">&quot;Contents:&quot;</span>);</div>
<div class="line">        <a class="code" href="console_8h.html#a6e0a771b0a8f2034a7f49684b107542e">cputs</a>(buffer);</div>
<div class="line">      }</div>
<div class="line">      rv = f_lseek(&amp;fil_obj, f_size(&amp;fil_obj));</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Seek to end got %d\n&quot;</span>, rv);</div>
<div class="line">      <span class="keywordflow">if</span> (FR_OK == rv) {</div>
<div class="line">        <span class="keywordtype">int</span> nb = snprintf(buffer, <span class="keyword">sizeof</span>(buffer), <span class="stringliteral">&quot;Booted build &quot;</span> __DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">        UINT nw;</div>
<div class="line">        rv = f_write(&amp;fil_obj, buffer, nb, &amp;nw);</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;write %u got %d nw %u\n&quot;</span>, nb, rv, nw);</div>
<div class="line">      }</div>
<div class="line">      f_close(&amp;fil_obj);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (FATFS_IS_PRE_R0_10 - 0)</span></div>
<div class="line">  f_mount(0, NULL);</div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* Pre R0.10 */</span><span class="preprocessor"></span></div>
<div class="line">  f_mount(NULL, NULL, 1);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* Pre R0.10 */</span><span class="preprocessor"></span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Exiting application\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="ex_platform_exp430f5529_fatfs_config"></a>
bsp430_config.h</h1>
<div class="fragment"><div class="line"><span class="comment">/* Use a crystal if one is installed.  Much more accurate timing</span></div>
<div class="line"><span class="comment"> * results. */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_PLATFORM_BOOT_CONFIGURE_LFXT1 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Application does output: support spin-for-jumper */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_PLATFORM_SPIN_FOR_JUMPER 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Support console output */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_CONSOLE 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Monitor uptime and provide generic ACLK-driven timer */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_UPTIME 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Explicitly require SPI via serial abstraction */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_SERIAL_ENABLE_SPI 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* SD card is on USCI B1, which by default is port-mapped to P4 */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_HAL_USCI5_B1 1</span></div>
<div class="line"><span class="preprocessor">#define APP_SD_SPI_PERIPH_HANDLE BSP430_PERIPH_USCI5_B1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* For some SD cards/holders, MISO may need to be pulled up.  Normally</span></div>
<div class="line"><span class="comment"> * SPI doesn&#39;t require this so the pin configuration doesn&#39;t do it.</span></div>
<div class="line"><span class="comment"> * Unfortunately we don&#39;t provide a way to introspect into the</span></div>
<div class="line"><span class="comment"> * specific pins and ports used by the peripheral handle, so we need</span></div>
<div class="line"><span class="comment"> * to hard-code this, and on the exp430f5529 MISO is on P4.2 */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_HPL_PORT4 1</span></div>
<div class="line"><span class="preprocessor">#define APP_SD_MISO_PORT_PERIPH_HANDLE BSP430_PERIPH_PORT4</span></div>
<div class="line"><span class="preprocessor">#define APP_SD_MISO_PORT_BIT BIT2</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* The chip select for the SD card is on P3.7 */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_HPL_PORT3 1</span></div>
<div class="line"><span class="preprocessor">#define APP_SD_CS_PORT_PERIPH_HANDLE BSP430_PERIPH_PORT3</span></div>
<div class="line"><span class="preprocessor">#define APP_SD_CS_PORT_BIT BIT7</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* MMC SD requires that the dummy byte that cues a read be 0xFF */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_SERIAL_SPI_READ_TX_BYTE(i_) 0xFF</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Get platform defaults */</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="bsp430__config_8h.html">bsp430/platform/bsp430_config.h</a>&gt;</span></div>
</div><!-- fragment --><h1><a class="anchor" id="ex_platform_exp430f5529_fatfs_make"></a>
Makefile</h1>
<div class="fragment"><div class="line">PLATFORM ?= exp430f5529</div>
<div class="line">TEST_PLATFORMS=exp430f5529</div>
<div class="line">AUX_CPPFLAGS = -Ifatfs/src</div>
<div class="line">MODULES=$(MODULES_PLATFORM)</div>
<div class="line">MODULES += $(MODULES_UPTIME)</div>
<div class="line">MODULES += $(MODULES_CONSOLE)</div>
<div class="line">MODULES += $(MODULES_SERIAL)</div>
<div class="line">MODULES += periph/sys</div>
<div class="line">MODULES += periph/pmm</div>
<div class="line">SRC=bsp430mmc.c main.c fatfs/src/ff.c</div>
<div class="line">include $(BSP430_ROOT)/make/Makefile.common</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Nov 15 2014 11:27:13 for BSP430 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
