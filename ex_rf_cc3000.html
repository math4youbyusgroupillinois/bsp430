<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>BSP430: CC3000 SimpleLink Exploration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSP430
   &#160;<span id="projectnumber">20141115</span>
   </div>
   <div id="projectbrief">Board Support Package for MSP430 microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">CC3000 SimpleLink Exploration </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#ex_rf_cc3000_demo">Available Commands and Examples</a><ul><li class="level2"><a href="#ex_rf_cc3000_demo_boot">Basic Boot with Manual Configuration</a></li>
<li class="level2"><a href="#ex_rf_cc3000_demo_smart">Smart Configuration</a></li>
<li class="level2"><a href="#ex_rf_cc3000_demo_profile">Multiple Profile Automated Configuration</a></li>
</ul>
</li>
<li class="level1"><a href="#ex_rf_cc3000_spi">cc3000spi.c</a></li>
<li class="level1"><a href="#ex_rf_cc3000_main">main.c</a></li>
<li class="level1"><a href="#ex_rf_cc3000_config">bsp430_config.h</a></li>
<li class="level1"><a href="#ex_rf_cc3000_make">Makefile</a></li>
</ul>
</div>
<div class="textblock"><p>This example is a fairly complex program demonstrating the basic goal that drove BSP430 development: the ability to quickly develop tools to explore new capabilities in an interactive fashion without being tied to a particular MSP430 product line or board, and to abstract the capabilities as modules that could be used in other applications.</p>
<p>The <a href="http://processors.wiki.ti.com/index.php/CC3000_Wi-Fi_for_MCU">Texas Instruments SimpleLink(TM) CC3000 Wi-Fi SOC</a> is a solution intended to enable microcontrollers to communicate over 802.11 Wi-Fi networks. It is available in RF evaluation module form-factor, and comes with example programs from Texas Instruments that are mostly tested on the <a href="http://www.ti.com/tool/msp-exp430f5529lp">MSP-EXP430F5529LP "USB Launchpad"</a>.</p>
<p>The example here uses the TI-provided host driver with a BSP430 SPI interface to provide an interactive program to invoke various capabilities of the SimpleLink hardware.</p>
<p>To build the program, you will need a copy of the CC3000 Host Driver. This application uses one that has been repackaged to place header files out of the application namespace, support MSPGCC, fix a few bugs, and support building as a library that can be linked into an application. It can be obtained from: <a href="http://github.com/pabigot/cc3000">http://github.com/pabigot/cc3000</a></p>
<p>An example build command line is: </p><pre class="fragment">make PLATFORM=exp430f5529lp \
   CC3000_ROOT=/usr/local/msp430-cc3000 \
   CC3000BOOST=1 \
   WITH_SMART=1 WITH_PROFILES=1 WITH_RMPARAM=1 \
   install
</pre><p>Several build-time flags control available features: </p><ul>
<li>
<code>CC3000_ROOT</code> specifies the location that you used as the <code>&ndash;prefix</code> argument to configure and install the CC3000 host driver. </li>
<li>
<code>CC3000_BOOST=1</code> enables the pin mappings for the <a href="http://www.ti.com/tool/cc3000boost">CC3000 BoosterPack</a>. By default (without this flag) the application will be built assuming a <a href="http://www.ti.com/tool/cc3000em">CC3000 Evaluation Module</a> is present in the platform's <a class="el" href="rfem_8h.html">RFEM </a> socket. </li>
<li>
<code>WITH_SMART=1</code> enables TI's <a href="http://processors.wiki.ti.com/index.php/CC3000_Smart_Config">CC3000 Smart Config</a> protocol, which uses an Android or IOS application to communicate WiFi access point information to the device without manual configuration. This mode requires 1500 bytes of RAM for receive packets, which is enabled with this flag. The <code>smart</code> command is absent without this option. </li>
<li>
<code>WITH_PROFILES=1</code> reads a set of access point definitions from a file <code>profiles.inc</code> in the source directory, allowing the <code>wlan profile update</code> command to store them for automatic connection without using Smart Config. </li>
<li>
<code>WITH_RMPARAM=1</code> reads the set of default radio module parameters from <code>rm_param.inc</code> in the source directory. This allows <code>nvm rmparam</code> to display the differences between the in-radio parameters and the standard parameters. </li>
<li>
<code>WITH_UPDATE=1</code> provides the ability to update the firmware of an otherwise-working CC3000. Due to licensing and/or export restrictions on the distribution of the firmware, you will need to download the patch utility sources from <a href="http://processors.wiki.ti.com/index.php/CC3000_Patch_Programmer">the TI Wiki</a>, extract the firmware image contents from the source files, and place them in files in the local file system. Instructions are in the source code. The two images together exceed 11 kB of flash, so enabling this feature may cause a small-memory-model build to fail. The <code>nvm update</code> command is absent without this option. </li>
</ul>
<h1><a class="anchor" id="ex_rf_cc3000_demo"></a>
Available Commands and Examples</h1>
<p>The API is a command-line, it supports editing commands, and will accept the shortest unique command prefix. Below are the commands supported when built with the options above. </p><pre class="fragment">help # No help available
test # No help available
uptime # No help available
mdns [name] # enable/disable mDNS
info # No help available
  load # load wlan AP params from INFO_B
  erase # erase INFO_B
  store # store wlan AP params in INFO_B
  dump # display INFO_B contents
nvmem # No help available
  mac # get mac address
  read fileid [len(=128) [ofs(=0)]] # read block from nvmem file
  rmparam # display radio module parameters
  sp # read firmware service pack level
  create [fileid=12 [length=16]] # create a new NVMEM section
  dir # describe NVMEM sections
scan # No help available
  start  [interval=1] # start periodic scan (ms)
  stop # disable periodic scan
  show  [with_mem=0] # display scan results
wlan # No help available
  start [patchcount=0] # power-up CC3000
  timeouts # set CC3000 timeouts
  status # get CC3000 status and AP config
  smart # No help available
    start [encrypted=0] # start smart config process
    stop # stop smart config process
    process # process AES received data
    aes [key] # set or read AES key
  profile # No help available
    update [profile=0] # add configured profiles
    del [profile=0] # delete profile, 255 for all
  connect # connect to specified access point using AP config
  autocon [open_ap=0 [fast_conn=1 [auto_conn=1]]]
  sectype [{sectype}] # Display or set AP sectype
  passphrase [{passphrase}] # Display or set AP passphrase
  ssid [{ssid}] # Display or set AP SSID for connect
  ipconfig # show IP parameters
  disconnect # disconnect from AP
  stop # shut down CC3000
</pre><h2><a class="anchor" id="ex_rf_cc3000_demo_boot"></a>
Basic Boot with Manual Configuration</h2>
<p>A demonstration boot sequence with a couple commands is: </p><pre class="fragment">cc3000 Mar 10 2014 12:00:54
System reset bitmask 4; causes:
        RST/NMI
System reset included: BOR POR PUC
PWR_EN at PORT6.5
SPI_IRQ HAL at PORT2.0
CSn HAL at PORT2.2
SPI is USCI5_B0
SPI Pins: MOSI/SDA=P3.0; MISO/SCL=P3.1; CLK=P3.2; STE=P2.7
CC3000 host driver: 15
Mar 10 2014 12:00:54
 0:00.807 Initialize returned 0

And wlan has been started.
ERR: Stored connection params invalid
&gt; wlan ssid myssid
AP SSID is myssid (7 chars)
&gt; wlan passph key-for-myssid
AP passphrase is 'key-for-myssid' (15 chars)
&gt; wlan sec wpa2
AP security type is wpa2 (3)
&gt; wlan con
connect to ssid 'myssid' by wpa2 using 'key-for-myssid'
con 0 in  0:06.334
&gt;  0:26.615 wlan_cb 0x8001 0 at 0 SR 0x44
 0:26.678 wlan_cb 0x8010 21 at 0x43ba SR 0x44
w ip
IP: 192.168.0.100
NM: 255.255.255.0
GW: 192.168.0.1
DHCP: 192.168.0.1
DNS: 192.168.0.1
MAC: 08:00:28:57:d4:df
SSID: myssid
&gt; info store
Erasing stored params at 0x1900...0
Copying current configuration...106
Command execution returned 106
&gt;
</pre><ul>
<li>
<code>nvm sp</code> displays the service pack and host driver versions. Unfortunately these don't conform to the package version distributed by TI: for example, firmware version 1.26 and host driver 15 are really SP 1.12. </li>
<li>
<code>wlan ssid</code> specifies the access point SSID to which connection should be made. The passphrase and security type are provided similarly. </li>
<li>
<code>wlan connect</code> initiates a manual connection to the specified access point. Note that asynchronous callbacks from the host driver are displayed as they arrive. </li>
<li>
<code>wlan ipconfig</code> displays the IP configuration of the device. </li>
<li>
<code>info store</code> saves the configured access point parameters in the MSP430 Information Section B so they need not be entered when the MCU is power-cycled. </li>
</ul>
<h2><a class="anchor" id="ex_rf_cc3000_demo_smart"></a>
Smart Configuration</h2>
<p>Although Smart Config can be used without encryption, you'll probably want to use it for any real-world application. The encryption key is stored in the NVMEM section of the CC3000. Display the NVMEM file table with this command: </p><pre class="fragment">&gt; nvm dir
16 NVMEM files with 14 documented:
ID Addr  Size  Flg : Doc ID  Size Description
 0 01f0   416  av         0   512 NVS
 1 0050   416  a          1   512 NVS (shadow)
 2 0390  4096  av         2  4096 WLAN Config
 3 1390  4096  av         3  4096 WLAN Config (shadow)
 4 2390  8192  av         4     0 WLAN Driver SP
 5 4390  8192  av         5     0 WLAN Firmware SP
 6 6390    16  av         6    16 MAC address
 7 63a0    16  a          7     0 Front End Vars ??
 8 63b0    64  a          8    64 IP Config
 9 63f0    64  a          9    64 IP Config (shadow)
10 6430  1024  a         10     0 Bootloader SP
11 6830   512  av        11     0 Radio Module
12 0000     0            12     0 AES128 Key
13 0000     0            13     0 Shared Memory ??
14 6a30    64  av
15 0000     0
</pre><p> If this table shows that file 12, which holds the AES key, does not have the available and valid flags (<code>av</code>), create it: </p><pre class="fragment">&gt; nvm create
nvmem_create_entry(12, 16) got 0
</pre><p> The file entry should now be: </p><pre class="fragment">12 6a70    16  a         12     0 AES128 Key
</pre><p> Store a key with this command: </p><pre class="fragment">&gt; wlan smart aes 123456789abcdef0
aes_write_key got 0
Key:
0000  31 32 33 34 35 36 37 38  39 61 62 63 64 65 66 30    123456789abcdef0
</pre><p> The key must be ASCII and a full 16 characters. The FAT entry will update to mark the section valid: </p><pre class="fragment">12 6a70    16  av        12     0 AES128 Key
</pre><p> You can now initiate the smart config process on your Android or IOS device, and at the demo application do the following: </p><pre class="fragment">&gt; wlan smart start 1
Prefix set returned 0
Config with AES key:
0000  31 32 33 34 35 36 37 38  39 61 62 63 64 65 66 30    123456789abcdef0
wlan_smart_config_start(1) got 0
&gt; wlan smart stop
wlan_smart_config_stop() got 0
&gt; wlan smart process
wlan_smart_config_process() got 0
&gt; wlan autocon
Current connection policy:
should_connect_to_open_ap = 0x00000000
should_use_fast_connect = 0x00000000
use_profiles = 0x00000000
New connection policy: open_ap=0 fast_connect=1 use_profiles=1
Connection policy set got 0
&gt; wlan stop
&gt; wlan start
wlan_start(0) took  0:01.190
&gt;  0:36.572 wlan_cb 0x8001 0 at 0 SR 0x44
 0:37.212 wlan_cb 0x8010 21 at 0x43ba SR 0x44
wlan ip
IP: 192.168.0.100
NM: 255.255.255.0
GW: 192.168.0.1
DHCP: 192.168.0.1
DNS: 192.168.0.1
MAC: 08:00:28:57:d4:df
SSID: myssid
&gt;
</pre> <ul>
<li>
<code>wlan smart start 1</code> starts the Smart Config process with encryption enabled. You can pass zero (or leave the last argument off) to do unencrypted configuration. When the driver is working properly there should be an event notification when configuration is complete: <pre class="fragment">&gt;  0:27.488 wlan_cb 0x8080 0 at 0 SR 0x44
</pre> The host driver for service pack 1.12 does not display this event, so after about twenty seconds assume it worked and keep going. </li>
<li>
<code>wlan smart stop</code> stops the configuration process. If you were doing an unencrypted configuration, the received access point data would be written to profile 1 by this operation. </li>
<li>
<code>wlan smart process</code> is used for encrypted configuration to decrypt the access point data and write it to profile 1. </li>
<li>
<code>wlan autocon</code> ensures that the autoconnect parameters are set to do fast-connect and use profiles. </li>
<li>
Stopping and starting the device allows it to autoconnect to the smart-configured AP. </li>
</ul>
<h2><a class="anchor" id="ex_rf_cc3000_demo_profile"></a>
Multiple Profile Automated Configuration</h2>
<p>Manual configuration works, but the startup procedure is slow. Smart Configuration is a pain when you have the ability to interact with the device. The following sequence shows how to store a set of profiles with priorities when the application is built with <code>WITH_PROFILES=1</code>: </p><pre class="fragment">&gt; wlan profile del
 7:53.662 wlan_cb 0x8010 21 at 0x42d0 SR 0x44
 7:53.710 wlan_cb 0x8002 0 at 0 SR 0x44
Del profile 255 got 0
&gt; wlan profile update
Add SSID 'pab-stream' sec 'wpa2' pri 3 got 0
Add SSID 'pabmn' sec 'wpa2' pri 2 got 1
Add SSID 'pab-llc' sec 'wpa2' pri 1 got 2
&gt; wlan stop
&gt; wlan start
wlan_start(0) took  0:01.190
&gt;  8:29.536 wlan_cb 0x8001 0 at 0 SR 0x44
 8:30.647 wlan_cb 0x8010 21 at 0x43ba SR 0x44
w ip
IP: 192.168.66.244
NM: 255.255.252.0
GW: 192.168.64.1
DHCP: 192.168.66.10
DNS: 192.168.66.10
MAC: 08:00:28:57:d4:df
SSID: pab-stream
&gt;
</pre> <ul>
<li>
<code>wlan profile del</code> deletes the profiles stored in the CC3000 NVMEM. Note that deleting a profile while connected to it causes the link to come down (producing asynchronous events). </li>
<li>
<code>wlan profile update</code> stores profiles that defined in a local file <code>profiles.inc</code>. This file specifies the priority, security mode, SSID, and passphrase for the AP. The return value from the add operation is the position of the entry, but this isn't very useful since the host API provides no way to read the profile table (you can pull the bits out of <code>NVMEM_NVS_FILEID</code> if you wish). </li>
<li>
<p class="startli">Stopping and starting causes the autoconnect process to execute using the highest-priority available access point. </p>
<p class="endli"></p>
</li>
</ul>
<h1><a class="anchor" id="ex_rf_cc3000_spi"></a>
cc3000spi.c</h1>
<p>The CC3000 Host Driver library is independent of the underlying interface via SPI. A demonstration interface for specific MSP430 processors is part of the TI example programs, but it is rather confusing and has board-specific material tightly integrated.</p>
<p>The &lt;bsp430/rf/cc3000spi.h&gt; header bridges between the host driver and BSP430's serial abstraction following the specfication at the <a href="http://processors.wiki.ti.com/index.php/CC3000_Host_Driver_Porting_Guide">CC3000 Host Driver Porting Guide</a>.</p>
<h1><a class="anchor" id="ex_rf_cc3000_main"></a>
main.c</h1>
<p>The bulk of the application is taken up with bridge code that interprets user input and invokes CC3000 host API calls. It is mostly of interest in that it demonstrates how to arrange command definitions so they can be easily included/excluded based on available memory.</p>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="platform_8h.html">bsp430/platform.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="clock_8h.html">bsp430/clock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="port_8h.html">bsp430/periph/port.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="sys_8h.html">bsp430/periph/sys.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="flash_8h.html">bsp430/periph/flash.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="pmm_8h.html">bsp430/periph/pmm.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#if (BSP430_CORE_TOOLCHAIN_GCC_MSPGCC - 0)</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/crtld.h&gt;</span></div>
<div class="line"><span class="preprocessor">#elif (BSP430_CORE_TOOLCHAIN_GCC_MSP430_ELF - 0)</span></div>
<div class="line"><span class="preprocessor">#ifdef __MSP430F5438A__</span></div>
<div class="line"><span class="preprocessor">#define __infob ((unsigned char *)0x1980)</span></div>
<div class="line"><span class="preprocessor">#define __info_segment_size 128</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* get info section information */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="uptime_8h.html">bsp430/utility/uptime.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="console_8h.html">bsp430/utility/console.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="led_8h.html">bsp430/utility/led.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cli_8h.html">bsp430/utility/cli.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cc3000_8h.html">bsp430/rf/cc3000.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/host_driver_version.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/wlan.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/nvmem.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/netapp.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/hci.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/security.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cc3000/socket.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ctype.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifndef BYPASS_SP_LOAD</span></div>
<div class="line"><span class="comment">/* If defined to a true value, the wlan_init() call at power-up will</span></div>
<div class="line"><span class="comment"> * inhibit loading of any service packs that may be present in the</span></div>
<div class="line"><span class="comment"> * NVMEM.  This will allow you to get access to the board when the</span></div>
<div class="line"><span class="comment"> * NVMEM is corrupt.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * BSP430 does not currently have support for complete restoration of</span></div>
<div class="line"><span class="comment"> * the NVMEM, which includes defining the FAT, providing radio module</span></div>
<div class="line"><span class="comment"> * parameters, etc. */</span></div>
<div class="line"><span class="preprocessor">#define BYPASS_SP_LOAD 0</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BYPASS_SP_LOAD */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Memory is extremely tight on the FR5739 (16 kB including CC3000</span></div>
<div class="line"><span class="comment"> * buffers).  Set these to restrict the set of commands to ones of</span></div>
<div class="line"><span class="comment"> * interest that will fit.  You&#39;ll probably find you&#39;ll need to</span></div>
<div class="line"><span class="comment"> * disable WLAN_CONNECT, which makes this pretty useless.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * On the EXP430G2 there isn&#39;t enough memory to do anything, so</span></div>
<div class="line"><span class="comment"> * disable everything.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * No issues on the &quot;real&quot; chips: MSP430F5438, MSP430F5529, .... */</span></div>
<div class="line"><span class="preprocessor">#if ! (BSP430_PLATFORM_EXP430G2 - 0)</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN_BROKEN 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN_STOP 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN_STATUS 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN_CONNECT 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN_IPCONFIG 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN_DISCONNECT 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN_START 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN_PROFILE 1</span></div>
<div class="line"><span class="preprocessor">#if (BSP430_CC3000_ENABLE_SMART - 0) &amp;&amp; (BSP430_CC3000SPI_RX_BUFFER_SIZE &lt; 1500)</span></div>
<div class="line"><span class="preprocessor">#error BSP430_CC3000_ENABLE_SMART requires BSP430_CC3000SPI_RX_BUFFER_SIZE &gt;= 1500</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_CC3000_ENABLE_SMART diagnostic */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#ifndef CMD_WLAN_SMART</span></div>
<div class="line"><span class="preprocessor">#define CMD_WLAN_SMART (BSP430_CC3000SPI_RX_BUFFER_SIZE &gt;= 1500)</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_SMART */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define CMD_NVMEM 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_NVMEM_SP 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_NVMEM_RMPARAM 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_NVMEM_READ 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_NVMEM_MAC 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_SCAN 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_INFO 1</span></div>
<div class="line"><span class="preprocessor">#define CMD_HELP 1</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CC3000BOOST */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (NO_HELP - 0)</span></div>
<div class="line"><span class="preprocessor">#define HELP_STRING(h_) NULL</span></div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* NO_HELP */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define HELP_STRING(h_) h_</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* NO_HELP */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAGIC_CONNECT_PARAMS 0x3000</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_SSID_LEN 32</span></div>
<div class="line"><span class="preprocessor">#define MAX_PASSPHRASE_LEN 64</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sConnectParams {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> magic;</div>
<div class="line">  <span class="keywordtype">int</span> security_type;</div>
<div class="line">  <span class="keywordtype">size_t</span> ssid_len;</div>
<div class="line">  <span class="keywordtype">size_t</span> passphrase_len;</div>
<div class="line">  <span class="keywordtype">char</span> ssid[MAX_SSID_LEN+1];</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> passphrase[MAX_PASSPHRASE_LEN+1];</div>
<div class="line">} sConnectParams;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint32_t lebtohl (uint8_t * vp)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> ((uint32_t)vp[0]</div>
<div class="line">          | ((uint32_t)vp[1] &lt;&lt; 8)</div>
<div class="line">          | ((uint32_t)vp[2] &lt;&lt; 16)</div>
<div class="line">          | ((uint32_t)vp[3] &lt;&lt; 24));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> uint32_t bebtohl (uint8_t * vp)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> ((uint32_t)vp[3]</div>
<div class="line">          | ((uint32_t)vp[2] &lt;&lt; 8)</div>
<div class="line">          | ((uint32_t)vp[1] &lt;&lt; 16)</div>
<div class="line">          | ((uint32_t)vp[0] &lt;&lt; 24));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *</div>
<div class="line">ipv4AsText (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * ipaddr)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">char</span> buffer[16];</div>
<div class="line">  snprintf(buffer, <span class="keyword">sizeof</span>(buffer), <span class="stringliteral">&quot;%u.%u.%u.%u&quot;</span>, ipaddr[3], ipaddr[2], ipaddr[1], ipaddr[0]);</div>
<div class="line">  <span class="keywordflow">return</span> buffer;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *</div>
<div class="line">net_ipv4AsText (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * ipaddr)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">char</span> buffer[16];</div>
<div class="line">  snprintf(buffer, <span class="keyword">sizeof</span>(buffer), <span class="stringliteral">&quot;%u.%u.%u.%u&quot;</span>, ipaddr[0], ipaddr[1], ipaddr[2], ipaddr[3]);</div>
<div class="line">  <span class="keywordflow">return</span> buffer;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lastKeepAlive_utt;</div>
<div class="line"><span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> lastCallback_utt;</div>
<div class="line"><span class="keyword">volatile</span> <span class="keywordtype">long</span> lastEventType;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> wlan_cb (<span class="keywordtype">long</span> event_type,</div>
<div class="line">                     <span class="keywordtype">char</span> * data,</div>
<div class="line">                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> length)</div>
<div class="line">{</div>
<div class="line">  lastEventType = event_type;</div>
<div class="line">  lastCallback_utt = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Ignore unsolicited keep-alives, which occur every 10 seconds</span></div>
<div class="line"><span class="comment">   * whenever the WLAN has been started, regardless of whether it&#39;s</span></div>
<div class="line"><span class="comment">   * connected or scanning. */</span></div>
<div class="line">  <span class="keywordflow">if</span> (HCI_EVNT_WLAN_KEEPALIVE == event_type) {</div>
<div class="line">    lastKeepAlive_utt = lastCallback_utt;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%s wlan_cb %#lx %u at %p SR %#x\n&quot;</span>,</div>
<div class="line">          <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(lastCallback_utt),</div>
<div class="line">          event_type, length, data, __read_status_register());</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">const</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> * commandSet;</div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND NULL</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN - 0)</span></div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND NULL</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_STOP - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_stop (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  wlan_stop();</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_stop = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;stop&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# shut down CC3000&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_stop</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_stop</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_STOP */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_DISCONNECT - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_disconnect (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rl = wlan_disconnect();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;disconnect returned %ld\n&quot;</span>, rl);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_disconnect = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;disconnect&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# disconnect from AP&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_disconnect</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_disconnect</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_DISCONNECT */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_IPCONFIG - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_ipconfig (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  tNetappIpconfigRetArgs ipc;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * p;</div>
<div class="line"></div>
<div class="line">  memset(&amp;ipc, 0, <span class="keyword">sizeof</span>(ipc));</div>
<div class="line">  netapp_ipconfig(&amp;ipc);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;IP: %s\n&quot;</span>, ipv4AsText(ipc.aucIP));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;NM: %s\n&quot;</span>, ipv4AsText(ipc.aucSubnetMask));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;GW: %s\n&quot;</span>, ipv4AsText(ipc.aucDefaultGateway));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;DHCP: %s\n&quot;</span>, ipv4AsText(ipc.aucDHCPServer));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;DNS: %s\n&quot;</span>, ipv4AsText(ipc.aucDNSServer));</div>
<div class="line">  p = ipc.uaMacAddr;</div>
<div class="line">  <span class="comment">/* WTF?  A little-endian MAC address?  This may be because of a bug</span></div>
<div class="line"><span class="comment">   * fix in the host driver; the original version was completely</span></div>
<div class="line"><span class="comment">   * wrong. */</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;MAC: %02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</div>
<div class="line">          p[5], p[4], p[3], p[2], p[1], p[0]);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SSID: %s\n&quot;</span>, ipc.uaSSID);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_ipconfig = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;ipconfig&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# show IP parameters&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_ipconfig</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_ipconfig</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_dhcp (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">int</span> store_ipc = 0;</div>
<div class="line">  <span class="keywordtype">long</span> lrc;</div>
<div class="line">  <span class="keyword">union </span>{</div>
<div class="line">    uint32_t u32;</div>
<div class="line">    uint8_t u8[4];</div>
<div class="line">  } address[4];</div>
<div class="line"></div>
<div class="line">  (void)<a class="code" href="group__grp__utility__cli__hci.html#ga91a46c6159bd5218814c96cbc28a60db">iBSP430cliStoreExtractedI</a>(&amp;argstr, &amp;argstr_len, &amp;store_ipc);</div>
<div class="line">  <span class="keywordflow">if</span> (store_ipc) {</div>
<div class="line">    tNetappIpconfigRetArgs ipc;</div>
<div class="line">    memset(&amp;ipc, 0, <span class="keyword">sizeof</span>(ipc));</div>
<div class="line">    netapp_ipconfig(&amp;ipc);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Copying DHCP from IP config\n&quot;</span>);</div>
<div class="line">    address[0].u32 = bebtohl(ipc.aucIP);</div>
<div class="line">    address[1].u32 = bebtohl(ipc.aucSubnetMask);</div>
<div class="line">    address[2].u32 = bebtohl(ipc.aucDefaultGateway);</div>
<div class="line">    address[3].u32 = bebtohl(ipc.aucDNSServer);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Clearing DHCP config\n&quot;</span>);</div>
<div class="line">    memset(address, 0, <span class="keyword">sizeof</span>(address));</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;IP: %s\n&quot;</span>, net_ipv4AsText(address[0].u8));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;NM: %s\n&quot;</span>, net_ipv4AsText(address[1].u8));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;GW: %s\n&quot;</span>, net_ipv4AsText(address[2].u8));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;DNS: %s\n&quot;</span>, net_ipv4AsText(address[3].u8));</div>
<div class="line">  lrc = netapp_dhcp(&amp;address[0].u32,</div>
<div class="line">                    &amp;address[1].u32,</div>
<div class="line">                    &amp;address[2].u32,</div>
<div class="line">                    &amp;address[3].u32);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;dhcp got %ld\n&quot;</span>, lrc);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_dhcp = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;dhcp&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[1] # reset(0)/set(1) dhcp params&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_dhcp</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_dhcp</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_IPCONFIG */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sWlanSecMap {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tag;</div>
<div class="line">} sWlanSecMap;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap wlanSecMap[] = {</div>
<div class="line">  { WLAN_SEC_UNSEC, <span class="stringliteral">&quot;unsec&quot;</span> },</div>
<div class="line">  { WLAN_SEC_WEP, <span class="stringliteral">&quot;wep&quot;</span> },</div>
<div class="line">  { WLAN_SEC_WPA, <span class="stringliteral">&quot;wpa&quot;</span> },</div>
<div class="line">  { WLAN_SEC_WPA2, <span class="stringliteral">&quot;wpa2&quot;</span> },</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap * <span class="keyword">const</span> wlanSecMap_end = wlanSecMap + <span class="keyword">sizeof</span>(wlanSecMap)/<span class="keyword">sizeof</span>(*wlanSecMap);</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap * wlanSecMapFromValue (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">  <span class="keywordflow">for</span> (mp = wlanSecMap; mp &lt; wlanSecMap_end; ++mp) {</div>
<div class="line">    <span class="keywordflow">if</span> (mp-&gt;val == val) {</div>
<div class="line">      <span class="keywordflow">return</span> mp;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sWlanSecMap * wlanSecMapFromTag (<span class="keyword">const</span> <span class="keywordtype">char</span> * tag)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">  <span class="keywordflow">for</span> (mp = wlanSecMap; mp &lt; wlanSecMap_end; ++mp) {</div>
<div class="line">    <span class="keywordflow">if</span> (0 == strcmp(mp-&gt;tag, tag)) {</div>
<div class="line">      <span class="keywordflow">return</span> mp;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_CONNECT - 0)</span></div>
<div class="line"></div>
<div class="line">sConnectParams connectParams;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_sectype (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> remaining = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">size_t</span> len;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tp;</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line"></div>
<div class="line">  tp = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;remaining, &amp;len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; len) {</div>
<div class="line">    mp = wlanSecMapFromTag(tp);</div>
<div class="line">    <span class="keywordflow">if</span> (0 != mp) {</div>
<div class="line">      connectParams.security_type = mp-&gt;val;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Unrecognized sectype &#39;%s&#39;: valid are&quot;</span>, tp);</div>
<div class="line">      <span class="keywordflow">for</span> (mp = wlanSecMap; mp &lt; wlanSecMap_end; ++mp) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot; %s&quot;</span>, mp-&gt;tag);</div>
<div class="line">      }</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  mp = wlanSecMapFromValue(connectParams.security_type);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP security type is %s (%u)\n&quot;</span>, (mp ? mp-&gt;tag : <span class="stringliteral">&quot;&lt;UNDEF&gt;&quot;</span>), connectParams.security_type);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_ssid (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> remaining = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">size_t</span> len;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tp;</div>
<div class="line"></div>
<div class="line">  tp = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;remaining, &amp;len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; len) {</div>
<div class="line">    memcpy(connectParams.ssid, tp, len);</div>
<div class="line">    connectParams.ssid[len] = 0;</div>
<div class="line">    connectParams.ssid_len = len;</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP SSID is %s (%u chars)\n&quot;</span>, connectParams.ssid, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)connectParams.ssid_len);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_passphrase (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> remaining = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">size_t</span> len;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tp;</div>
<div class="line"></div>
<div class="line">  tp = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;remaining, &amp;len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &lt; len) {</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(connectParams.passphrase) &lt;= (len+1)) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Passphrase too long (&gt; %u chars + EOS)\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(connectParams.passphrase));</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      memcpy(connectParams.passphrase, tp, len);</div>
<div class="line">      connectParams.passphrase[len] = 0;</div>
<div class="line">      connectParams.passphrase_len = len;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP passphrase is &#39;%s&#39; (%u chars)\n&quot;</span>, connectParams.passphrase, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)connectParams.passphrase_len);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_autocon (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> should_connect_to_open_ap = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> should_use_fast_connect = 1;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> use_profiles = 1;</div>
<div class="line">  uint8_t u32octets[4];</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Analysis shows:</span></div>
<div class="line"><span class="comment">   * should_connect_to_open_ap in NVS at 0x44 32-bit int</span></div>
<div class="line"><span class="comment">   * should_use_fast_connect in NVS at 0x48 32-bit int</span></div>
<div class="line"><span class="comment">   * use_profiles in NVS at 0x50 32-bit int */</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Current connection policy:\n&quot;</span>);</div>
<div class="line">  rc = nvmem_read(NVMEM_WLAN_CONFIG_FILEID, <span class="keyword">sizeof</span>(uint32_t), 0x44, u32octets);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;should_connect_to_open_ap = 0x%08lx\n&quot;</span>, lebtohl(u32octets));</div>
<div class="line">  }</div>
<div class="line">  rc = nvmem_read(NVMEM_WLAN_CONFIG_FILEID, <span class="keyword">sizeof</span>(uint32_t), 0x48, u32octets);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;should_use_fast_connect = 0x%08lx\n&quot;</span>, lebtohl(u32octets));</div>
<div class="line">  }</div>
<div class="line">  rc = nvmem_read(NVMEM_WLAN_CONFIG_FILEID, <span class="keyword">sizeof</span>(uint32_t), 0x50, u32octets);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;use_profiles = 0x%08lx\n&quot;</span>, lebtohl(u32octets));</div>
<div class="line">  }</div>
<div class="line">  rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;should_connect_to_open_ap);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">    rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;should_use_fast_connect);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">    rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;use_profiles);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;New connection policy: open_ap=%u fast_connect=%u use_profiles=%u\n&quot;</span>,</div>
<div class="line">          should_connect_to_open_ap, should_use_fast_connect, use_profiles);</div>
<div class="line">  rc = wlan_ioctl_set_connection_policy(should_connect_to_open_ap, should_use_fast_connect, use_profiles);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Connection policy set got %ld\n&quot;</span>, rc);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_connect (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rl;</div>
<div class="line">  <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t[2];</div>
<div class="line"></div>
<div class="line">  mp = wlanSecMapFromValue(connectParams.security_type);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;connect to ssid &#39;%s&#39; by %s using &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">          connectParams.ssid, (mp ? mp-&gt;tag : <span class="stringliteral">&quot;&lt;UNDEF&gt;&quot;</span>),</div>
<div class="line">          connectParams.passphrase);</div>
<div class="line">  t[0] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  rl = wlan_connect(connectParams.security_type,</div>
<div class="line">                    connectParams.ssid, connectParams.ssid_len,</div>
<div class="line">                    NULL,</div>
<div class="line">                    connectParams.passphrase, connectParams.passphrase_len);</div>
<div class="line">  t[1] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;con %ld in %s\n&quot;</span>, rl, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(t[1]-t[0]));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_ssid = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;ssid&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[{ssid}] # Display or set AP SSID for connect&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_ssid</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_passphrase = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;passphrase&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[{passphrase}] # Display or set AP passphrase&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_ssid,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_passphrase</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_sectype = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;sectype&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[{sectype}] # Display or set AP sectype&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_passphrase,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_sectype</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_autocon = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;autocon&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[open_ap=0 [fast_conn=1 [auto_conn=1]]]&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_sectype,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_autocon</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_connect = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;connect&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# connect to specified access point using AP config&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_autocon,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_connect</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_connect</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_CONNECT */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_PROFILE - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_profile_del (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line">  <span class="keywordtype">int</span> profile = 255;</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Use 255 to delete all profiles. */</span></div>
<div class="line">  (void)<a class="code" href="group__grp__utility__cli__hci.html#ga91a46c6159bd5218814c96cbc28a60db">iBSP430cliStoreExtractedI</a>(&amp;argstr, &amp;argstr_len, &amp;profile);</div>
<div class="line">  rc = wlan_ioctl_del_profile(profile);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Del profile %d got %ld\n&quot;</span>, profile, rc);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sProfileEntry {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> priority;        </div>
<div class="line">  <span class="keywordtype">int</span> security_type;            </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * ssid;            </div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * passphrase;      </div>
<div class="line">} sProfileEntry;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_profile_update (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> sProfileEntry entries[] = {</div>
<div class="line"><span class="preprocessor">#if (WITH_PROFILES - 0)</span></div>
<div class="line"><span class="preprocessor">#include &quot;profiles.inc&quot;</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* WITH_PROFILES */</span><span class="preprocessor"></span></div>
<div class="line">  };</div>
<div class="line">  <span class="keyword">const</span> sProfileEntry * pep = entries;</div>
<div class="line">  <span class="keyword">const</span> sProfileEntry * <span class="keyword">const</span> pepe = pep + <span class="keyword">sizeof</span>(entries)/<span class="keyword">sizeof</span>(*entries);</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (pep == pepe) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;No profiles available\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Per</span></div>
<div class="line"><span class="comment">   * http://e2e.ti.com/support/low_power_rf/f/851/p/285991/999909.aspx#999909</span></div>
<div class="line"><span class="comment">   * the magic constants below are from wpa_supplicant. */</span></div>
<div class="line"><span class="preprocessor">#define WPA_DRIVER_CAPA_KEY_MGMT_WPA2              0x00000002</span></div>
<div class="line"><span class="preprocessor">#define WPA_CIPHER_NONE 0x01</span></div>
<div class="line"><span class="preprocessor">#define WPA_CIPHER_WEP40 0x02</span></div>
<div class="line"><span class="preprocessor">#define WPA_CIPHER_WEP104 0x04</span></div>
<div class="line"><span class="preprocessor">#define WPA_CIPHER_TKIP 0x08</span></div>
<div class="line"><span class="preprocessor">#define WPA_CIPHER_CCMP 0x10</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span> (pep &lt; pepe) {</div>
<div class="line">    uint32_t pairwisecipher_or_keylen = 0;</div>
<div class="line">    uint32_t groupcipher_or_keyindex = 0;</div>
<div class="line">    uint32_t key_mgmt = 0;</div>
<div class="line">    uint8_t * pf_or_key = NULL;</div>
<div class="line">    uint32_t key_length = 0;</div>
<div class="line">    <span class="keyword">const</span> sWlanSecMap * <span class="keyword">const</span> mp = wlanSecMapFromValue(pep-&gt;security_type);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (NULL != mp) {</div>
<div class="line">      <span class="keywordflow">if</span> ((WLAN_SEC_WPA == pep-&gt;security_type)</div>
<div class="line">          || (WLAN_SEC_WPA2 == pep-&gt;security_type)) {</div>
<div class="line">        pairwisecipher_or_keylen = WPA_CIPHER_TKIP | WPA_CIPHER_CCMP;</div>
<div class="line">        groupcipher_or_keyindex = WPA_CIPHER_WEP40 | WPA_CIPHER_WEP104 | WPA_CIPHER_TKIP | WPA_CIPHER_CCMP;</div>
<div class="line">        key_mgmt = WPA_DRIVER_CAPA_KEY_MGMT_WPA2;</div>
<div class="line">        pf_or_key = (uint8_t*)pep-&gt;passphrase;</div>
<div class="line">        key_length = strlen(pep-&gt;passphrase);</div>
<div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WLAN_SEC_WEP == pep-&gt;security_type) {</div>
<div class="line">        pairwisecipher_or_keylen = strlen(pep-&gt;passphrase);</div>
<div class="line">        groupcipher_or_keyindex = 0;</div>
<div class="line">        key_mgmt = 0;</div>
<div class="line">        pf_or_key = (uint8_t*)pep-&gt;passphrase;</div>
<div class="line">        key_length = 0;</div>
<div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WLAN_SEC_UNSEC == pep-&gt;security_type) {</div>
<div class="line">        pairwisecipher_or_keylen = 0;</div>
<div class="line">        groupcipher_or_keyindex = 0;</div>
<div class="line">        key_mgmt = 0;</div>
<div class="line">        pf_or_key = NULL;</div>
<div class="line">        key_length = 0;</div>
<div class="line">      }</div>
<div class="line">      rc = wlan_add_profile(pep-&gt;security_type,</div>
<div class="line">                            (uint8_t*)pep-&gt;ssid,</div>
<div class="line">                            strlen(pep-&gt;ssid),</div>
<div class="line">                            NULL,   <span class="comment">/* bssid is inferred */</span></div>
<div class="line">                            pep-&gt;priority,</div>
<div class="line">                            pairwisecipher_or_keylen,</div>
<div class="line">                            groupcipher_or_keyindex,</div>
<div class="line">                            key_mgmt,</div>
<div class="line">                            pf_or_key,</div>
<div class="line">                            key_length);</div>
<div class="line"></div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Add SSID &#39;%s&#39; sec &#39;%s&#39; pri %u got %ld\n&quot;</span>,</div>
<div class="line">              pep-&gt;ssid, mp-&gt;tag, pep-&gt;priority, rc);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Profile %u %s has invalid security type %d\n&quot;</span>,</div>
<div class="line">              (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(pep - entries),</div>
<div class="line">              pep-&gt;ssid, pep-&gt;security_type);</div>
<div class="line">    }</div>
<div class="line">    ++pep;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_profile_del = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;del&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[profile=0] # delete profile, 255 for all&quot;</span>),</div>
<div class="line">  .next = NULL,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_profile_del</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_profile_update = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;update&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[profile=0] # add configured profiles&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_profile_del,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_profile_update</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_profile = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;profile&quot;</span>,</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .child = &amp;dcmd_wlan_profile_update</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_profile</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_PROFILE */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_SMART - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_smart_aes (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * key = NULL;</div>
<div class="line">  <span class="keywordtype">size_t</span> keylen;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> keybuf[AES128_KEY_SIZE];</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span> (isspace((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*argstr)) {</div>
<div class="line">    ++argstr;</div>
<div class="line">  }</div>
<div class="line">  argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordflow">if</span> (*argstr) {</div>
<div class="line">    key = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;argstr_len, &amp;keylen);</div>
<div class="line">    memset(keybuf, 0, <span class="keyword">sizeof</span>(keybuf));</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(keybuf) &lt; keylen) {</div>
<div class="line">      keylen = <span class="keyword">sizeof</span>(keybuf);</div>
<div class="line">    }</div>
<div class="line">    memcpy(keybuf, key, keylen);</div>
<div class="line">    rc = aes_write_key(keybuf);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;aes_write_key got %ld\n&quot;</span>, rc);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    rc = aes_read_key(keybuf);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;aes_read_key got %ld\n&quot;</span>, rc);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Key:\n&quot;</span>);</div>
<div class="line">  <a class="code" href="console_8h.html#afd126d6b4a6180ae3de71c17a52357c0">vBSP430consoleDisplayMemory</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)keybuf, <span class="keyword">sizeof</span>(keybuf), 0);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_smart_process (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line"></div>
<div class="line">  rc = wlan_smart_config_process();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;wlan_smart_config_process() got %ld\n&quot;</span>, rc);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_smart_stop (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line"></div>
<div class="line">  rc = wlan_smart_config_stop();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;wlan_smart_config_stop() got %ld\n&quot;</span>, rc);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_smart_start (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> encrypted = 0;</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* This has to be TTT.  It doesn&#39;t matter what you pass as long as</span></div>
<div class="line"><span class="comment">   * it&#39;s non-null; SP 1.10.1 through 1.12 (at least) will use TTT.</span></div>
<div class="line"><span class="comment">   * In fact, it will helpfully overwrite whatever you pass in so that</span></div>
<div class="line"><span class="comment">   * you know you&#39;re using TTT.  So you can&#39;t pass a string literal</span></div>
<div class="line"><span class="comment">   * unless your MCU allows you to write into flash, which is probably</span></div>
<div class="line"><span class="comment">   * a bad thing to promote given the use of FRAM devices. */</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">char</span> prefix[] = <span class="stringliteral">&quot;123&quot;</span>;</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Setting prefix to &#39;%s&#39;\n&quot;</span>, prefix);</div>
<div class="line">    rc = wlan_smart_config_set_prefix(prefix);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Prefix set returned %ld, now &#39;%s&#39;\n&quot;</span>, rc, prefix);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  (void)<a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;encrypted);</div>
<div class="line">  <span class="keywordflow">if</span> (encrypted) {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> keybuf[AES128_KEY_SIZE];</div>
<div class="line">    rc = aes_read_key(keybuf);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Config with AES key:\n&quot;</span>);</div>
<div class="line">    <a class="code" href="console_8h.html#afd126d6b4a6180ae3de71c17a52357c0">vBSP430consoleDisplayMemory</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)keybuf, <span class="keyword">sizeof</span>(keybuf), 0);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Config unencrypted\n&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  rc = wlan_smart_config_start(encrypted);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;wlan_smart_config_start(%d) got %ld\n&quot;</span>, encrypted, rc);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_smart_aes = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;aes&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[key] # set or read AES key&quot;</span>),</div>
<div class="line">  .next = NULL,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_smart_aes</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_smart_process = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;process&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# process AES received data&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_smart_aes,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_smart_process</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_smart_stop = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;stop&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# stop smart config process&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_smart_process,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_smart_stop</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_smart_start = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;start&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[encrypted=0] # start smart config process&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_wlan_smart_stop,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_smart_start</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_smart = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;smart&quot;</span>,</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .child = &amp;dcmd_wlan_smart_start</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_smart</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_SMART */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_STATUS - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_status (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">/* Contrary to the documentation, there are no macro constants</span></div>
<div class="line"><span class="comment">   * defined for these states */</span></div>
<div class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * status_str[] = {</div>
<div class="line">    <span class="stringliteral">&quot;disconnected&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;scanning&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;connecting&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;connected&quot;</span></div>
<div class="line">  };</div>
<div class="line">  <span class="keywordtype">long</span> rl = wlan_ioctl_statusget();</div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_CONNECT - 0)</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> sWlanSecMap * mp;</div>
<div class="line">    mp = wlanSecMapFromValue(connectParams.security_type);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP configuration SSID &#39;%s&#39;, passphrase &#39;%s&#39;\n&quot;</span>,</div>
<div class="line">            connectParams.ssid, connectParams.passphrase);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;AP security type %s (%u)\n&quot;</span>, (mp ? mp-&gt;tag : <span class="stringliteral">&quot;&lt;UNDEF&gt;&quot;</span>), connectParams.security_type);</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_CONNECT */</span><span class="preprocessor"></span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;WLAN status %ld&quot;</span>, rl);</div>
<div class="line">  <span class="keywordflow">if</span> ((0 &lt;= rl) &amp;&amp; (rl &lt; (<span class="keyword">sizeof</span>(status_str)/<span class="keyword">sizeof</span>(*status_str)))) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;: %s&quot;</span>, status_str[rl]);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_status = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;status&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# get CC3000 status and AP config&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_status</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_status</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_STATUS */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_BROKEN - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_timeouts (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line">  <span class="keyword">struct </span>{</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> dhcp_s;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> arp_s;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ka_s;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> inactive_s;</div>
<div class="line">  } params;</div>
<div class="line"></div>
<div class="line">  params.dhcp_s = 14400;</div>
<div class="line">  params.arp_s = 3600;</div>
<div class="line">  params.ka_s = 600000;</div>
<div class="line">  params.inactive_s = 600000;</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;*** NOTE: No evidence this function works (KA does not)\n&quot;</span>);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;DHCP timeout: %lu sec\n&quot;</span>, params.dhcp_s);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ARP timeout: %lu sec\n&quot;</span>, params.arp_s);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Keep-Alive timeout: %lu sec\n&quot;</span>, params.ka_s);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Inactive timeout: %lu sec\n&quot;</span>, params.inactive_s);</div>
<div class="line">  rc = netapp_timeout_values(&amp;params.dhcp_s, &amp;params.arp_s, &amp;params.ka_s, &amp;params.inactive_s);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Timeout set got %ld\n&quot;</span>, rc);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_timeouts = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;timeouts&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# set CC3000 timeouts&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_timeouts</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_timeouts</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_BROKEN */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_START - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_wlan_start (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> patches_available = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t[2];</div>
<div class="line"></div>
<div class="line">  (void)<a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;patches_available);</div>
<div class="line">  t[0] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  wlan_start(patches_available);</div>
<div class="line">  t[1] = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;wlan_start(%u) took %s\n&quot;</span>, patches_available, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(t[1]-t[0]));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan_start = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;start&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[patchcount=0] # power-up CC3000&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_wlan_start</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_wlan_start</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_START */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_wlan = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;wlan&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = LAST_SUB_COMMAND</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_wlan</span></div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND NULL</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_SCAN - 0)</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define X_WLAN_SCAN_STATUS_AGED 0</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define X_WLAN_SCAN_STATUS_VALID 1</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define X_WLAN_SCAN_STATUS_NONE 2</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sWLANFullScanResults {</div>
<div class="line">  uint32_t network_count;</div>
<div class="line">  uint32_t scan_status;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> isValid:1;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rssi:7;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> securityMode:2;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ssidNameLength:6;</div>
<div class="line">  uint16_t entryTime;</div>
<div class="line">  <span class="keywordtype">char</span> ssid[32];</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bssid[6];</div>
<div class="line">} sWLANFullScanResults;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_scan_show (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">int</span> with_mem = 0;</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line">  <span class="keyword">union </span>{</div>
<div class="line">    sWLANFullScanResults structure;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> bytes[1];</div>
<div class="line">  } uresult;</div>
<div class="line">  <span class="keyword">const</span> sWLANFullScanResults * <span class="keyword">const</span> sp = &amp;uresult.structure;</div>
<div class="line"></div>
<div class="line">  (void)<a class="code" href="group__grp__utility__cli__hci.html#ga91a46c6159bd5218814c96cbc28a60db">iBSP430cliStoreExtractedI</a>(&amp;argstr, &amp;argstr_len, &amp;with_mem);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Scan results:\n&quot;</span></div>
<div class="line">          <span class="stringliteral">&quot;SSID                             &quot;</span></div>
<div class="line">          <span class="stringliteral">&quot;Scty  &quot;</span></div>
<div class="line">          <span class="stringliteral">&quot;BSSID             &quot;</span></div>
<div class="line">          <span class="stringliteral">&quot;RSSI &quot;</span></div>
<div class="line">          <span class="stringliteral">&quot;Time&quot;</span></div>
<div class="line">          <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    rc = wlan_ioctl_get_scan_results(0, uresult.bytes);</div>
<div class="line">    <span class="keywordflow">if</span> (0 != rc) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: rc %ld\n&quot;</span>, rc);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (X_WLAN_SCAN_STATUS_NONE == sp-&gt;scan_status) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;No results\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (X_WLAN_SCAN_STATUS_AGED == sp-&gt;scan_status) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;No new results\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (! sp-&gt;isValid) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Invalid\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (with_mem) {</div>
<div class="line">      <a class="code" href="console_8h.html#afd126d6b4a6180ae3de71c17a52357c0">vBSP430consoleDisplayMemory</a>(uresult.bytes, <span class="keyword">sizeof</span>(*sp), 0);</div>
<div class="line">    }</div>
<div class="line">    { <span class="comment">/* SSID */</span></div>
<div class="line">      <span class="keyword">const</span> <span class="keywordtype">int</span> nsp = sp-&gt;ssidNameLength;</div>
<div class="line">      <span class="keywordtype">int</span> i;</div>
<div class="line">      <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(sp-&gt;ssid); ++i) {</div>
<div class="line">        <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>((i &lt; nsp) ? sp-&gt;ssid[i] : <span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">      }</div>
<div class="line">      <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(<span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">    }</div>
<div class="line">    { <span class="comment">/* Security */</span></div>
<div class="line">      <span class="keyword">const</span> sWlanSecMap * mp = wlanSecMapFromValue(sp-&gt;securityMode);</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%-5s &quot;</span>, (NULL == mp) ? <span class="stringliteral">&quot;???&quot;</span> : mp-&gt;tag);</div>
<div class="line">    }</div>
<div class="line">    { <span class="comment">/* BSSI */</span></div>
<div class="line">      <span class="keywordtype">int</span> i;</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%02x&quot;</span>, sp-&gt;bssid[0]);</div>
<div class="line">      <span class="keywordflow">for</span> (i = 1; i &lt; <span class="keyword">sizeof</span>(sp-&gt;bssid); ++i) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;:%02x&quot;</span>, sp-&gt;bssid[i]);</div>
<div class="line">      }</div>
<div class="line">      <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(<span class="charliteral">&#39; &#39;</span>); <span class="comment">/* 17 chars plus separating space */</span></div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;% 3d  &quot;</span>, -128 + sp-&gt;rssi); <span class="comment">/* RSSI */</span></div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%-5u &quot;</span>, sp-&gt;entryTime);    <span class="comment">/* Time */</span></div>
<div class="line">    <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line">  } <span class="keywordflow">while</span> (1 &lt; sp-&gt;network_count);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_scan_start (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> interval_ms = 1;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> delays[16];</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">  (void)<a class="code" href="group__grp__utility__cli__hci.html#gac1d3224f520dabd275954219dac876f8">iBSP430cliStoreExtractedUL</a>(&amp;argstr, &amp;argstr_len, &amp;interval_ms);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(delays)/<span class="keyword">sizeof</span>(*delays); ++i) {</div>
<div class="line">    delays[i] = 2000;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  rc = wlan_ioctl_set_scan_params(interval_ms, <span class="comment">/* Enable (1 is 10 min interval; other values are interval between active probe sweeps, in ms) */</span></div>
<div class="line">                                  100, <span class="comment">/* Min dwell per channel */</span></div>
<div class="line">                                  150, <span class="comment">/* Max dwell per channel */</span></div>
<div class="line">                                  5,  <span class="comment">/* Probes within dwell.  0 will still send one probe. */</span></div>
<div class="line">                                  0x7ff, <span class="comment">/* Channel mask: 0x7ff enables 1..11 */</span></div>
<div class="line">                                  -80,   <span class="comment">/* Default RSSI threshold.  No apparent effect changing this. */</span></div>
<div class="line">                                  0,   <span class="comment">/* SNR threshold */</span></div>
<div class="line">                                  205, <span class="comment">/* Probe TX power */</span></div>
<div class="line">                                  delays); <span class="comment">/* Timeout between scans */</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Scan start %lu ms got %ld\n&quot;</span>, interval_ms, rc);</div>
<div class="line">  <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_scan_stop (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> rc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> delays[16];</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(delays)/<span class="keyword">sizeof</span>(*delays); ++i) {</div>
<div class="line">    delays[i] = 2000;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* This stops the scan within the current session, but it will</span></div>
<div class="line"><span class="comment">   * automatically restart on the next power-up. */</span></div>
<div class="line">  rc = wlan_ioctl_set_scan_params(0, 150, 150, 5, 0x1fff, -80, 0, 205, delays);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Scan stop got %ld\n&quot;</span>, rc);</div>
<div class="line">  <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_scan_show = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;show&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot; [with_mem=0] # display scan results&quot;</span>),</div>
<div class="line">  .next = NULL,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_scan_show</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_scan_stop = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;stop&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# disable periodic scan&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_scan_show,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_scan_stop</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_scan_start = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;start&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot; [interval=1] # start periodic scan (ms)&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_scan_stop,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_scan_start</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_scan = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;scan&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = &amp;dcmd_scan_start</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_scan</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_SCAN */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM - 0)</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>sNVMEMFileIds {</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fileid;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * tag;</div>
<div class="line">} sNVMEMFileIds;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> sNVMEMFileIds nvmemFiles[] = {</div>
<div class="line">  { NVMEM_NVS_FILEID, 512, <span class="stringliteral">&quot;NVS&quot;</span>, },</div>
<div class="line">  { NVMEM_NVS_SHADOW_FILEID, 512, <span class="stringliteral">&quot;NVS (shadow)&quot;</span> },</div>
<div class="line">  { NVMEM_WLAN_CONFIG_FILEID, 4096, <span class="stringliteral">&quot;WLAN Config&quot;</span>, },</div>
<div class="line">  { NVMEM_WLAN_CONFIG_SHADOW_FILEID, 4096, <span class="stringliteral">&quot;WLAN Config (shadow)&quot;</span> },</div>
<div class="line">  { NVMEM_WLAN_DRIVER_SP_FILEID, 0, <span class="stringliteral">&quot;WLAN Driver SP&quot;</span> },</div>
<div class="line">  { NVMEM_WLAN_FW_SP_FILEID, 0, <span class="stringliteral">&quot;WLAN Firmware SP&quot;</span> },</div>
<div class="line">  { NVMEM_MAC_FILEID, 16, <span class="stringliteral">&quot;MAC address&quot;</span> },</div>
<div class="line">  { NVMEM_FRONTEND_VARS_FILEID, 0, <span class="stringliteral">&quot;Front End Vars ??&quot;</span> },</div>
<div class="line">  { NVMEM_IP_CONFIG_FILEID, 64, <span class="stringliteral">&quot;IP Config&quot;</span> },</div>
<div class="line">  { NVMEM_IP_CONFIG_SHADOW_FILEID, 64, <span class="stringliteral">&quot;IP Config (shadow)&quot;</span> },</div>
<div class="line">  { NVMEM_BOOTLOADER_SP_FILEID, 0, <span class="stringliteral">&quot;Bootloader SP&quot;</span> },</div>
<div class="line">  { NVMEM_RM_FILEID, 0, <span class="stringliteral">&quot;Radio Module&quot;</span> },</div>
<div class="line">  { NVMEM_AES128_KEY_FILEID, 0, <span class="stringliteral">&quot;AES128 Key&quot;</span> },</div>
<div class="line">  { NVMEM_SHARED_MEM_FILEID, 0, <span class="stringliteral">&quot;Shared Memory ??&quot;</span> },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (WITH_UPDATE - 0)</span></div>
<div class="line"><span class="comment">/* Firmware updates for the CC3000 are distributed by TI through the</span></div>
<div class="line"><span class="comment"> * Patch Programmer utility available at:</span></div>
<div class="line"><span class="comment"> * http://processors.wiki.ti.com/index.php/CC3000_Wi-Fi_Downloads#Patch_Programmer</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This utility is export-controlled, and there is no indication that</span></div>
<div class="line"><span class="comment"> * the binary firmware data is licensed with rights to redistribute.</span></div>
<div class="line"><span class="comment"> * Therefore, if you want to update firmware or compare radio module</span></div>
<div class="line"><span class="comment"> * parameters, you need to obtain the source to the patch programmer</span></div>
<div class="line"><span class="comment"> * and create files that contain the byte literal initializer sequence</span></div>
<div class="line"><span class="comment"> * to fill in the arrays below. */</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* This array should hold WLAN driver patches.  The length is</span></div>
<div class="line"><span class="comment"> * somewhere around 8kB, and the values can be found in the</span></div>
<div class="line"><span class="comment"> * wlan_drv_patch array in PatchProgrammer_DR_Patch.c from the TI</span></div>
<div class="line"><span class="comment"> * patch programmer utility. */</span></div>
<div class="line"><span class="keyword">const</span> uint8_t wlan_drv_patch[] = {</div>
<div class="line"><span class="preprocessor">#include &quot;wlan_drv_patch.inc&quot;</span></div>
<div class="line">};</div>
<div class="line"><span class="comment">/* This array should hold WLAN firmware patches.  The length is</span></div>
<div class="line"><span class="comment"> * somewhere around 8kB, and the values can be found in the fw_patch</span></div>
<div class="line"><span class="comment"> * array in PatchProgrammer_FW_Patch.c from the TI patch programmer</span></div>
<div class="line"><span class="comment"> * utility. */</span></div>
<div class="line"><span class="keyword">const</span> uint8_t fw_patch[] = {</div>
<div class="line"><span class="preprocessor">#include &quot;fw_patch.inc&quot;</span></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_update (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keywordtype">int</span> stage;</div>
<div class="line">  <span class="keyword">const</span> uint16_t drv_sp_size = <span class="keyword">sizeof</span>(wlan_drv_patch);</div>
<div class="line">  <span class="keyword">const</span> uint16_t fw_sp_size = <span class="keyword">sizeof</span>(fw_patch);</div>
<div class="line">  uint16_t drv_sp_fatsize;</div>
<div class="line">  uint16_t fw_sp_fatsize;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    stage = __LINE__;</div>
<div class="line">    rc = nvmem_read(NVMEM_MAX_ENTRY, <span class="keyword">sizeof</span>(drv_sp_fatsize), 4*(1 + NVMEM_WLAN_DRIVER_SP_FILEID) + 2, (uint8_t*)&amp;drv_sp_fatsize);</div>
<div class="line">    <span class="keywordflow">if</span> (0 != rc) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    stage = __LINE__;</div>
<div class="line">    rc = nvmem_read(NVMEM_MAX_ENTRY, <span class="keyword">sizeof</span>(drv_sp_fatsize), 4*(1 + NVMEM_WLAN_FW_SP_FILEID) + 2, (uint8_t*)&amp;fw_sp_fatsize);</div>
<div class="line">    <span class="keywordflow">if</span> (0 != rc) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Driver update size %u, file size %u\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;Firmware update size %u, file size %u\n&quot;</span>,</div>
<div class="line">            drv_sp_size, drv_sp_fatsize,</div>
<div class="line">            fw_sp_size, fw_sp_fatsize);</div>
<div class="line">    <span class="keywordflow">if</span> ((0 == drv_sp_size) || (drv_sp_size &gt; drv_sp_fatsize)) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERROR: No driver, or driver too large\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((0 == fw_sp_size) || (fw_sp_size &gt; fw_sp_fatsize)) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERROR: No firmware, or firmware too large\n&quot;</span>);</div>
<div class="line">      <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Shutting down WLAN for driver update\n&quot;</span>);</div>
<div class="line">    wlan_stop();</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Waiting a few...&quot;</span>);</div>
<div class="line">    <a class="code" href="core_8h.html#a3124959aa09ef7d745fb63c9ff5ee897">BSP430_CORE_DELAY_CYCLES</a>(3 * <a class="code" href="clock_8h.html#a6ffd3f4fab35b64d0e8ff8d3179d69d9">BSP430_CLOCK_NOMINAL_MCLK_HZ</a>);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;back now\n&quot;</span>);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Starting WLAN in patch mode\n&quot;</span>);</div>
<div class="line">    wlan_start(2);</div>
<div class="line">    wlan_ioctl_set_connection_policy(0, 0, 0);</div>
<div class="line">    wlan_ioctl_del_profile(255);</div>
<div class="line">    wlan_set_event_mask(HCI_EVNT_WLAN_KEEPALIVE|HCI_EVNT_WLAN_UNSOL_INIT|HCI_EVNT_WLAN_ASYNC_PING_REPORT);</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Updating driver firmware...&quot;</span>);</div>
<div class="line">    stage = __LINE__;</div>
<div class="line">    rc = nvmem_write_patch(NVMEM_WLAN_DRIVER_SP_FILEID, drv_sp_size, (uint8_t *)wlan_drv_patch);</div>
<div class="line">    <span class="keywordflow">if</span> (0 != rc) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;success.\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;Updating firmware...&quot;</span>);</div>
<div class="line">    stage = __LINE__;</div>
<div class="line">    rc = nvmem_write_patch(NVMEM_WLAN_FW_SP_FILEID, fw_sp_size, (uint8_t *)fw_patch);</div>
<div class="line">    <span class="keywordflow">if</span> (0 != rc) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;success.\n&quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;Shutting down WLAN after driver update\n&quot;</span>);</div>
<div class="line">    wlan_stop();</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Restarting WLAN with new drivers\n&quot;</span>);</div>
<div class="line">    wlan_start(0);</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <span class="keywordflow">if</span> (0 != rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERROR %d in update at line %u\n&quot;</span>, rc, stage);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_update = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;update&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# Update firmware&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_nvmem_update</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_update</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* WITH_UPDATE */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_dir (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_doc_files = <span class="keyword">sizeof</span>(nvmemFiles) / <span class="keyword">sizeof</span>(*nvmemFiles);</div>
<div class="line">  uint8_t fat[4*(NVMEM_MAX_ENTRY+1)];</div>
<div class="line">  <span class="keyword">const</span> uint16_t * fp = (<span class="keyword">const</span> uint16_t *)(fat+4);</div>
<div class="line">  <span class="keyword">const</span> uint16_t * efp = (<span class="keyword">const</span> uint16_t *)(fat+<span class="keyword">sizeof</span>(fat));</div>
<div class="line">  <span class="keywordtype">int</span> ffi = 0;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%u NVMEM files with %u documented:\n&quot;</span>, NVMEM_MAX_ENTRY, num_doc_files);</div>
<div class="line">  rc = nvmem_read(NVMEM_MAX_ENTRY, <span class="keyword">sizeof</span>(fat), 0, fat);</div>
<div class="line">  <span class="keywordflow">if</span> (0 != rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERROR: nvmem read got %d\n&quot;</span>, rc);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> ((<span class="charliteral">&#39;L&#39;</span> != fat[0]) || (<span class="charliteral">&#39;S&#39;</span> != fat[1])) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERROR: nvmem signature %02x %02x not %02x %02x\n&quot;</span>,</div>
<div class="line">            fat[0], fat[1], <span class="charliteral">&#39;L&#39;</span>, <span class="charliteral">&#39;S&#39;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ID Addr  Size  Flg : Doc ID  Size Description\n&quot;</span>);</div>
<div class="line">  <span class="keywordflow">while</span> (fp &lt; efp) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%2d %04x %5d  %c%c%c&quot;</span>,</div>
<div class="line">            ffi, fp[0] &amp; ~(<a class="code" href="msp430_8h.html#ad4d43f8748b542bce39e18790f845ecc">BIT0</a>|<a class="code" href="msp430_8h.html#a601923eba46784638244c1ebf2622a2a">BIT1</a>|<a class="code" href="msp430_8h.html#a9c9560bccccb00174801c728f1ed1399">BIT2</a>), fp[1],</div>
<div class="line">            (fp[0] &amp; <a class="code" href="msp430_8h.html#ad4d43f8748b542bce39e18790f845ecc">BIT0</a>) ? <span class="charliteral">&#39;a&#39;</span> : <span class="charliteral">&#39; &#39;</span>,</div>
<div class="line">            (fp[0] &amp; <a class="code" href="msp430_8h.html#a601923eba46784638244c1ebf2622a2a">BIT1</a>) ? <span class="charliteral">&#39;v&#39;</span> : <span class="charliteral">&#39; &#39;</span>,</div>
<div class="line">            (fp[0] &amp; <a class="code" href="msp430_8h.html#a9c9560bccccb00174801c728f1ed1399">BIT2</a>) ? <span class="charliteral">&#39;p&#39;</span> : <span class="charliteral">&#39; &#39;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (ffi &lt; <span class="keyword">sizeof</span>(nvmemFiles)/<span class="keyword">sizeof</span>(*nvmemFiles)) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;       %2d %5d %s&quot;</span>,</div>
<div class="line">              nvmemFiles[ffi].fileid,</div>
<div class="line">              nvmemFiles[ffi].size,</div>
<div class="line">              nvmemFiles[ffi].tag);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line">    ++ffi;</div>
<div class="line">    fp += 2;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_dir = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;dir&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# describe NVMEM sections&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_nvmem_dir</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_dir</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_create (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fileid = NVMEM_AES128_KEY_FILEID;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length = AES128_KEY_SIZE;</div>
<div class="line">  <span class="keywordtype">long</span> rc;</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">  rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;fileid);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">    rv = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;length);</div>
<div class="line">  }</div>
<div class="line">  rc = nvmem_create_entry(fileid, length);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;nvmem_create_entry(%u, %u) got %ld\n&quot;</span>, fileid, length, rc);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_create = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;create&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[fileid=12 [length=16]] # create a new NVMEM section&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_nvmem_create</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_create</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM_SP - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_sp (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> patch_version[2];</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rv;</div>
<div class="line"></div>
<div class="line">  memset(patch_version, -1, <span class="keyword">sizeof</span>(patch_version));</div>
<div class="line">  rv = nvmem_read_sp_version(patch_version);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;sp ret %u: %u.%u\n&quot;</span>, rv, patch_version[0], patch_version[1]);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Host driver %u\n&quot;</span>, DRIVER_VERSION_NUMBER);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_sp = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;sp&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# read firmware service pack level&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_nvmem_sp</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_sp</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_SP */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM_RMPARAM - 0)</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (WITH_RMPARAM - 0)</span></div>
<div class="line"><span class="comment">/* This array should hold the default radio module parameters.  The</span></div>
<div class="line"><span class="comment"> * length is nominally 128 bytes, and the values can be found in the</span></div>
<div class="line"><span class="comment"> * cRMdefaultParams array in PatchProgrammer_DR_Patch.c from the TI</span></div>
<div class="line"><span class="comment"> * patch programmer utility. */</span></div>
<div class="line"><span class="keyword">const</span> uint8_t default_rm_param[] = {</div>
<div class="line"><span class="preprocessor">#include &quot;rm_param.inc&quot;</span></div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_rmparam (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  uint8_t rmparam[128];</div>
<div class="line">  <span class="keyword">const</span> uint8_t * <span class="keyword">const</span> rmpe = rmparam + <span class="keyword">sizeof</span>(rmparam);</div>
<div class="line">  uint8_t * rp = rmparam;</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span> (rp &lt; rmpe) {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset = rp - rmparam;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nb = rmpe - rp;</div>
<div class="line">    <span class="keywordflow">if</span> (16 &lt; nb) {</div>
<div class="line">      nb = 16;</div>
<div class="line">    }</div>
<div class="line">    rc = nvmem_read(NVMEM_RM_FILEID, nb, offset, rp);</div>
<div class="line">    <span class="keywordflow">if</span> (0 != rc) {</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERROR %d reading at offset %u\n&quot;</span>, rc, offset);</div>
<div class="line">      <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    rp += nb;</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Radio module parameters:\n&quot;</span>);</div>
<div class="line">  <a class="code" href="console_8h.html#afd126d6b4a6180ae3de71c17a52357c0">vBSP430consoleDisplayMemory</a>(rmparam, <span class="keyword">sizeof</span>(rmparam), 0);</div>
<div class="line"><span class="preprocessor">#if (WITH_RMPARAM - 0)</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keyword">const</span> uint8_t * drp = default_rm_param;</div>
<div class="line">    <span class="keyword">const</span> uint8_t * <span class="keyword">const</span> drpe = default_rm_param + <span class="keyword">sizeof</span>(default_rm_param);</div>
<div class="line"></div>
<div class="line">    rp = rmparam;</div>
<div class="line">    <span class="keywordflow">while</span> ((rp &lt; rmpe) &amp;&amp; (drp &lt; drpe)) {</div>
<div class="line">      *rp++ ^= *drp++;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Bitwise difference from default:\n&quot;</span>);</div>
<div class="line">  <a class="code" href="console_8h.html#afd126d6b4a6180ae3de71c17a52357c0">vBSP430consoleDisplayMemory</a>(rmparam, <span class="keyword">sizeof</span>(rmparam), 0);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Default RM parameters:\n&quot;</span>);</div>
<div class="line">  <a class="code" href="console_8h.html#afd126d6b4a6180ae3de71c17a52357c0">vBSP430consoleDisplayMemory</a>(default_rm_param, <span class="keyword">sizeof</span>(default_rm_param), 0);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* WITH_RMPARAM */</span><span class="preprocessor"></span></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_rmparam = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;rmparam&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# display radio module parameters&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_nvmem_rmparam</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_rmparam</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_SP */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM_READ - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_read (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fileid = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len = 128;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ofs = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> data[16];       <span class="comment">/* Page size? */</span></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> end_read;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ui;</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nb;</div>
<div class="line"></div>
<div class="line">  rc = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;ui);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    fileid = ui;</div>
<div class="line">    rc = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;ui);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    len = ui;</div>
<div class="line">    rc = <a class="code" href="group__grp__utility__cli__hci.html#gad6c6edd09983b8360f0a44d47ed32ec6">iBSP430cliStoreExtractedUI</a>(&amp;argstr, &amp;argstr_len, &amp;ui);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    ofs = ui;</div>
<div class="line">  }</div>
<div class="line">  end_read = ofs + len;</div>
<div class="line">  rc = 0;</div>
<div class="line">  <span class="keywordflow">while</span> ((0 == rc) &amp;&amp; (ofs &lt; end_read)) {</div>
<div class="line">    nb = (end_read - ofs);</div>
<div class="line">    <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(data) &lt; nb) {</div>
<div class="line">      nb = <span class="keyword">sizeof</span>(data);</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Return is 0 if successful, 4 if offset too large, 3 unknown</span></div>
<div class="line"><span class="comment">     * error. */</span></div>
<div class="line">    rc = nvmem_read(fileid, nb, ofs, data);</div>
<div class="line">    <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">      <a class="code" href="console_8h.html#afd126d6b4a6180ae3de71c17a52357c0">vBSP430consoleDisplayMemory</a>(data, nb, ofs);</div>
<div class="line">      ofs += nb;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span> (0 != rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\nERR: Read returned %u for %u bytes at %u of fileid %u\n&quot;</span>,</div>
<div class="line">            rc, nb, ofs, fileid);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_read = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;read&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;fileid [len(=128) [ofs(=0)]] # read block from nvmem file&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_nvmem_read</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_read</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_READ */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_NVMEM_MAC - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_nvmem_mac (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> mac[6];</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Could extend this to parse &quot;set {addr}&quot; if you wanted. */</span></div>
<div class="line">  rc = nvmem_get_mac_address(mac);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == rc) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;nvmem mac is %02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</div>
<div class="line">            mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: nvmem mac read got %u\n&quot;</span>, rc);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem_mac = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;mac&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# get mac address&quot;</span>),</div>
<div class="line">  .next = LAST_SUB_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_nvmem_mac</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND &amp;dcmd_nvmem_mac</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM_MAC */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_nvmem = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;nvmem&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = LAST_SUB_COMMAND</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_nvmem</span></div>
<div class="line"><span class="preprocessor">#undef LAST_SUB_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_SUB_COMMAND NULL</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_NVMEM */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if ! (BSP430_MODULE_FLASH - 0)</span></div>
<div class="line"><span class="comment">/* No support for this on FRAM boards yet */</span></div>
<div class="line"><span class="preprocessor">#undef CMD_INFO</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_INFO - 0)</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> sConnectParams * <span class="keyword">const</span> infoConnectParams = (sConnectParams *)__infob;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_load (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span> (MAGIC_CONNECT_PARAMS != infoConnectParams-&gt;magic) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;ERR: Stored connection params invalid\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#if (CMD_WLAN_CONNECT - 0)</span></div>
<div class="line">  connectParams = *infoConnectParams;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_WLAN_CONNECT */</span><span class="preprocessor"></span></div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_erase_ni (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Erasing stored params at %p...&quot;</span>, infoConnectParams);</div>
<div class="line">  rv = <a class="code" href="flash_8h.html#a94c76cef12d30a8fb476cb7664338285">iBSP430flashEraseSegment_ni</a>(infoConnectParams);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%d\n&quot;</span>, rv);</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_erase (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    rv = cmd_info_erase_ni();</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_store (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  <span class="keywordflow">do</span> {</div>
<div class="line">    rv = cmd_info_erase_ni();</div>
<div class="line">    <span class="keywordflow">if</span> (0 == rv) {</div>
<div class="line">      connectParams.magic = MAGIC_CONNECT_PARAMS;</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Copying current configuration...&quot;</span>);</div>
<div class="line">      rv = <a class="code" href="flash_8h.html#ae8561ad078b62fd3ceadabbe69421d5a">iBSP430flashWriteData_ni</a>(infoConnectParams, &amp;connectParams, <span class="keyword">sizeof</span>(connectParams));</div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%d\n&quot;</span>, rv);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">while</span> (0);</div>
<div class="line">  <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_info_dump (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Configuration memory:\n&quot;</span>);</div>
<div class="line">  <a class="code" href="console_8h.html#afd126d6b4a6180ae3de71c17a52357c0">vBSP430consoleDisplayMemory</a>((<span class="keyword">const</span> uint8_t *)infoConnectParams, __info_segment_size, (uintptr_t)infoConnectParams);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_dump = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;dump&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# display INFO_B contents&quot;</span>),</div>
<div class="line">  .next = NULL,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_info_dump</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_store = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;store&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# store wlan AP params in INFO_B&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_info_dump,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_info_store</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_erase = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;erase&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# erase INFO_B&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_info_store,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_info_erase</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info_load = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;load&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;# load wlan AP params from INFO_B&quot;</span>),</div>
<div class="line">  .next = &amp;dcmd_info_erase,</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#a896e8594759400c197809d7e346eabd8">handler</a> = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_info_load</div>
<div class="line">};</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_info = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;info&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .child = &amp;dcmd_info_load</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_info</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_INFO */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_mdns (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * name = <span class="stringliteral">&quot;CC3000&quot;</span>;</div>
<div class="line">  <span class="keywordtype">size_t</span> name_len;</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line"></div>
<div class="line">  name = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;argstr_len, &amp;name_len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == name_len) {</div>
<div class="line">    rc = mdnsAdvertiser(0, <span class="stringliteral">&quot;CC3000&quot;</span>, strlen(<span class="stringliteral">&quot;CC3000&quot;</span>));</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Will advertize: &#39;&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; name_len; ++i) {</div>
<div class="line">      <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(name[i]);</div>
<div class="line">    }</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;&#39;\n&quot;</span>);</div>
<div class="line">    rc = mdnsAdvertiser(1, (<span class="keywordtype">char</span> *)name, name_len);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;mdnsAdvertiser got %d\n&quot;</span>, rc);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_mdns = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;mdns&quot;</span>,</div>
<div class="line">  .help = HELP_STRING(<span class="stringliteral">&quot;[name] # enable/disable mDNS&quot;</span>),</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_mdns</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_mdns</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_uptime (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="core_8h.html#aa45390f99fe6b993083301d3613de4a3">BSP430_CORE_SAVED_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> now_utt;</div>
<div class="line">  <span class="keywordtype">char</span> timebuf[<a class="code" href="uptime_8h.html#ae47d677ac9443e2e26608ef5278f1a6d">BSP430_UPTIME_AS_TEXT_LENGTH</a>];</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#ac381d1a1ade729f63011e7e4db511f61">BSP430_CORE_DISABLE_INTERRUPT</a>();</div>
<div class="line">  now_utt = <a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>();</div>
<div class="line">  <a class="code" href="core_8h.html#ab2a0adfa112adbcaf1f834165fee15d3">BSP430_CORE_RESTORE_INTERRUPT_STATE</a>(istate);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Time: %s\n&quot;</span>, <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(now_utt, timebuf));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Last Event %lx: %s\n&quot;</span>, lastEventType, <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(lastCallback_utt, timebuf));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Last KA: %s\n&quot;</span>, <a class="code" href="uptime_8h.html#a1cb1310c769f028347010502456fb918">xBSP430uptimeAsText</a>(lastKeepAlive_utt, timebuf));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_uptime = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;uptime&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_uptime</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_uptime</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_ghbn (<span class="keyword">const</span> <span class="keywordtype">char</span> * argstr)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">size_t</span> argstr_len = strlen(argstr);</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * name;</div>
<div class="line">  <span class="keywordtype">size_t</span> name_len;</div>
<div class="line">  uint32_t addr = -1;</div>
<div class="line">  <span class="keywordtype">int</span> rc;</div>
<div class="line"></div>
<div class="line">  name = <a class="code" href="group__grp__utility__cli__hci.html#gabcda3dd127008a5cdcc5f40cac4e9e68">xBSP430cliNextQToken</a>(&amp;argstr, &amp;argstr_len, &amp;name_len);</div>
<div class="line">  <span class="keywordflow">if</span> (0 == name_len) {</div>
<div class="line">    name = <span class="stringliteral">&quot;ntp.pool.org&quot;</span>;</div>
<div class="line">    name_len = strlen(name);</div>
<div class="line">  }</div>
<div class="line">  rc = gethostbyname((<span class="keywordtype">char</span>*)name, name_len, &amp;addr);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;gethostbyname(%s) returned %d, ip: %s\n&quot;</span>, name, rc, ipv4AsText((<span class="keyword">const</span> uint8_t*)&amp;addr));</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_ghbn = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;ghbn&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = <a class="code" href="cli_8h.html#a3262960abdfc1bbfa7143bb79e9396ff">iBSP430cliHandlerSimple</a>,</div>
<div class="line">  .param.simple_handler = cmd_ghbn</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_ghbn</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_test (<a class="code" href="structsBSP430cliCommandLink.html">sBSP430cliCommandLink</a> * chain,</div>
<div class="line">          <span class="keywordtype">void</span> * param,</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">char</span> * command,</div>
<div class="line">          <span class="keywordtype">size_t</span> command_len)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_test = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;test&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = cmd_test</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_test</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_HELP - 0)</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">cmd_help (<a class="code" href="structsBSP430cliCommandLink.html">sBSP430cliCommandLink</a> * chain,</div>
<div class="line">          <span class="keywordtype">void</span> * param,</div>
<div class="line">          <span class="keyword">const</span> <span class="keywordtype">char</span> * command,</div>
<div class="line">          <span class="keywordtype">size_t</span> command_len)</div>
<div class="line">{</div>
<div class="line">  <a class="code" href="group__grp__utility__cli__cli.html#ga2c3a36a00ea6f676cf2006859364d45a">vBSP430cliConsoleDisplayHelp</a>(chain-&gt;<a class="code" href="structsBSP430cliCommandLink.html#ad4701a7a6b809d746683cb5b0a6f2018">cmd</a>);</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="structsBSP430cliCommand.html">sBSP430cliCommand</a> dcmd_help = {</div>
<div class="line">  .<a class="code" href="structsBSP430cliCommand.html#afc4749b003e26d829a7d9b92698edfd4">key</a> = <span class="stringliteral">&quot;help&quot;</span>,</div>
<div class="line">  .next = LAST_COMMAND,</div>
<div class="line">  .handler = cmd_help</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#undef LAST_COMMAND</span></div>
<div class="line"><span class="preprocessor">#define LAST_COMMAND &amp;dcmd_help</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* CMD_HELP */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> main (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> rv;</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span> * command;</div>
<div class="line">  <span class="keywordtype">int</span> flags;</div>
<div class="line"><span class="preprocessor">#if (BSP430_MODULE_SYS - 0)</span></div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> reset_causes = 0;</div>
<div class="line">  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> reset_flags = 0;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (BSP430_MODULE_SYS - 0)</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sysrstiv;</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Record all the reset causes */</span></div>
<div class="line">    <span class="keywordflow">while</span> (0 != ((sysrstiv = <a class="code" href="sys_8h.html#a49bc446977f788990eaf4de3e3b3d234">uiBSP430sysSYSRSTGenerator_ni</a>(&amp;reset_flags)))) {</div>
<div class="line">      reset_causes |= 1UL &lt;&lt; (sysrstiv / 2);</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#ifdef BSP430_PMM_ENTER_LPMXp5_NI</span></div>
<div class="line">    <span class="comment">/* If we woke from LPMx.5, we need to clear the lock in PM5CTL0.</span></div>
<div class="line"><span class="comment">     * We&#39;ll do it early, since we&#39;re not really interested in</span></div>
<div class="line"><span class="comment">     * retaining the current IFG settings. */</span></div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_LPM5WU) {</div>
<div class="line">      PMMCTL0_H = PMMPW_H;</div>
<div class="line">      PM5CTL0 = 0;</div>
<div class="line">      PMMCTL0_H = 0;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PMM_ENTER_LPMXp5_NI */</span><span class="preprocessor"></span></div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line">  <a class="code" href="platform_8h.html#a616515ce5e0f7635ca36a815841d2a21">vBSP430platformInitialize_ni</a>();</div>
<div class="line">  (void)<a class="code" href="console_8h.html#a91f5f68fa2ee29ca39bf9a23ea98cbe1">iBSP430consoleInitialize</a>();</div>
<div class="line">  <a class="code" href="cli_8h.html#a0a5b3cee7e2d9002d5d301b36c814d55">vBSP430cliSetDiagnosticFunction</a>(<a class="code" href="group__grp__utility__cli__cli.html#ga30922f40d6b2702628bb88d9e0069caf">iBSP430cliConsoleDiagnostic</a>);</div>
<div class="line">  <a class="code" href="core_8h.html#a3124959aa09ef7d745fb63c9ff5ee897">BSP430_CORE_DELAY_CYCLES</a>(<a class="code" href="clock_8h.html#a6ffd3f4fab35b64d0e8ff8d3179d69d9">BSP430_CLOCK_NOMINAL_MCLK_HZ</a> / 2);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\ncc3000 &quot;</span> __DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (BSP430_MODULE_SYS - 0)</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;System reset bitmask %lx; causes:\n&quot;</span>, reset_causes);</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">int</span> bit = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (bit &lt; (8 * <span class="keyword">sizeof</span>(reset_causes))) {</div>
<div class="line">      <span class="keywordflow">if</span> (reset_causes &amp; (1UL &lt;&lt; bit)) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\t%s\n&quot;</span>, <a class="code" href="sys_8h.html#a2012d634fbc0045a010a2158b37248f2">xBSP430sysSYSRSTIVDescription</a>(2*bit));</div>
<div class="line">      }</div>
<div class="line">      ++bit;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot;System reset included:&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (reset_flags) {</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_BOR) {</div>
<div class="line">      <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot; BOR&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_LPM5WU) {</div>
<div class="line">      <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot; LPM5WU&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_POR) {</div>
<div class="line">      <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot; POR&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (reset_flags &amp; BSP430_SYS_FLAG_SYSRST_PUC) {</div>
<div class="line">      <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot; PUC&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <a class="code" href="console_8h.html#ac4ebbf60b8d0840b3039203c47f61c86">cputtext</a>(<span class="stringliteral">&quot; no data&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">  <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_MODULE_SYS */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#ifdef BSP430_RF_CC3000_PWR_EN_PORT_PERIPH_HANDLE</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;PWR_EN at %s.%u\n&quot;</span>, <a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(<a class="code" href="cc3000_8h.html#a9ea80557fff7aa790e3426c079c6d600">BSP430_RF_CC3000_PWR_EN_PORT_PERIPH_HANDLE</a>), <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a class="code" href="cc3000_8h.html#af9e48a70bb8ea6a5b539169d4396ef77">BSP430_RF_CC3000_PWR_EN_PORT_BIT</a>));</div>
<div class="line"><span class="preprocessor">#else </span><span class="comment">/* BSP430_RF_CC3000_PWR_EN_PORT_PERIPH_HANDLE */</span><span class="preprocessor"></span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;No PWR_EN control.\n&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_RF_CC3000_PWR_EN_PORT_PERIPH_HANDLE */</span><span class="preprocessor"></span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SPI_IRQ HAL at %s.%u\n&quot;</span>, <a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(<a class="code" href="cc3000_8h.html#aae09ccedf7c2187f1f1735efb388d6d0">BSP430_RF_CC3000_IRQn_PORT_PERIPH_HANDLE</a>), <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a class="code" href="cc3000_8h.html#adc03dd477aa2cef3381422e55fa64ccb">BSP430_RF_CC3000_IRQn_PORT_BIT</a>));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;CSn HAL at %s.%u\n&quot;</span>, <a class="code" href="port_8h.html#a78a791b05b428f3aa2bf5ff09e907200">xBSP430portName</a>(<a class="code" href="cc3000_8h.html#aa79c82e6a548b47fa7abfbdefb6ff089">BSP430_RF_CC3000_CSn_PORT_PERIPH_HANDLE</a>), <a class="code" href="port_8h.html#aa9b72a778f0f690c08bba27871c4d374">iBSP430portBitPosition</a>(<a class="code" href="cc3000_8h.html#a23f128b4a07be6aaf86d98728cb47cca">BSP430_RF_CC3000_CSn_PORT_BIT</a>));</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SPI is %s\n&quot;</span>, <a class="code" href="serial_8h.html#a7f2e6f39abd1faca343663917e34840a">xBSP430serialName</a>(<a class="code" href="cc3000_8h.html#a3e70b19753c3299b6802619075c4d9be">BSP430_RF_CC3000_SPI_PERIPH_HANDLE</a>));</div>
<div class="line"><span class="preprocessor">#if BSP430_PLATFORM_PERIPHERAL_HELP</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;SPI Pins: %s\n&quot;</span>, <a class="code" href="platform_8h.html#ad5df0a450196592bc395c5efe89a6fb3">xBSP430platformPeripheralHelp</a>(<a class="code" href="cc3000_8h.html#a3e70b19753c3299b6802619075c4d9be">BSP430_RF_CC3000_SPI_PERIPH_HANDLE</a>, <a class="code" href="periph_8h.html#a5a28880814f93f755ea189df4e2d1900">BSP430_PERIPHCFG_SERIAL_SPI3</a>));</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* BSP430_PLATFORM_PERIPHERAL_HELP */</span><span class="preprocessor"></span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;CC3000 host driver: %u\n&quot;</span>, DRIVER_VERSION_NUMBER);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;RX buffer size %u, TX buffer size %u\n&quot;</span>,</div>
<div class="line">          <a class="code" href="cc3000_8h.html#ad0be8d9dad7f10d193314afbb436822e">BSP430_CC3000SPI_RX_BUFFER_SIZE</a>,</div>
<div class="line">          <a class="code" href="cc3000_8h.html#a91296e239f43b23894ff57a3d196a644">BSP430_CC3000SPI_TX_BUFFER_SIZE</a>);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(__DATE__ <span class="stringliteral">&quot; &quot;</span> __TIME__ <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Initialization can be done with interrupts disabled, since the</span></div>
<div class="line"><span class="comment">   * function does nothing but store callbacks.  We use the same</span></div>
<div class="line"><span class="comment">   * callback for all three update capabilities. */</span></div>
<div class="line">  rv = <a class="code" href="cc3000_8h.html#a18c48988f94c6984548d28e802377344">iBSP430cc3000spiInitialize</a>(wlan_cb, NULL, NULL, NULL);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;%s Initialize returned %d\n&quot;</span>, <a class="code" href="uptime_8h.html#a790fc3c41c4a8e93ec7caca7825733c1">xBSP430uptimeAsText_ni</a>(<a class="code" href="uptime_8h.html#ab4b2fa8646bfd0856d6a9b095db30e93">ulBSP430uptime_ni</a>()), rv);</div>
<div class="line">  <span class="keywordflow">if</span> (0 &gt; rv) {</div>
<div class="line">    <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Aborting due to failure to initialized\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  commandSet = LAST_COMMAND;</div>
<div class="line">  command = NULL;</div>
<div class="line">  flags = <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="core_8h.html#a954f39fe5652611f5a20f74289b0cfbf">BSP430_CORE_ENABLE_INTERRUPT</a>();</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* wlan_start() MUST be invoked with interrupts enabled.  Pass 0 for</span></div>
<div class="line"><span class="comment">   * a normal startup.  If the firmware is suspect, you need to pass 2</span></div>
<div class="line"><span class="comment">   * which will cause the NVMEM firmware sections to be ignored. */</span></div>
<div class="line"><span class="preprocessor">#if (BYPASS_SP_LOAD - 0)</span></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Bypassing service packs\n&quot;</span>);</div>
<div class="line">  wlan_start(2);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">  wlan_start(0);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\nAnd wlan has been started.\n&quot;</span>);</div>
<div class="line">  (void)<a class="code" href="console_8h.html#afd126d6b4a6180ae3de71c17a52357c0">vBSP430consoleDisplayMemory</a>;</div>
<div class="line">  rv = wlan_set_event_mask(0);</div>
<div class="line">  <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Unmask events returned %d\n&quot;</span>, rv);</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if (CMD_INFO - 0)</span></div>
<div class="line">  <span class="keywordflow">if</span> (0 == cmd_info_load(<span class="stringliteral">&quot;&quot;</span>)) {</div>
<div class="line">    cmd_wlan_status(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; eBSP430cliConsole_DO_COMPLETION) {</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_DO_COMPLETION;</div>
<div class="line">      flags |= <a class="code" href="group__grp__utility__cli__completion.html#ga5086d946e412fa4e9928819d664fc2cc">iBSP430cliConsoleBufferCompletion</a>(commandSet, &amp;command);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; eBSP430cliConsole_READY) {</div>
<div class="line">      <span class="keywordtype">int</span> rv;</div>
<div class="line"></div>
<div class="line">      rv = <a class="code" href="cli_8h.html#adcdb159a40c5cb6737cf97b497b58a55">iBSP430cliExecuteCommand</a>(commandSet, 0, command);</div>
<div class="line">      <span class="keywordflow">if</span> (0 != rv) {</div>
<div class="line">        <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;Command execution returned %d\n&quot;</span>, rv);</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">/* Ensure prompt is rewritten, but not the command we just</span></div>
<div class="line"><span class="comment">       * ran */</span></div>
<div class="line">      flags |= <a class="code" href="group__grp__utility__cli__cli.html#ggabf197215e696298dd3a9690ef10a69deaf4a31c8e1956488e1ff37d22d55936b3">eBSP430cliConsole_REPAINT</a>;</div>
<div class="line">      command = NULL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; eBSP430cliConsole_REPAINT) {</div>
<div class="line">      <span class="comment">/* Draw the prompt along with whatever&#39;s left in the command buffer */</span></div>
<div class="line">      <a class="code" href="console_8h.html#a20188454c5c787938220b7bcf3179869">cprintf</a>(<span class="stringliteral">&quot;\r&gt; %s&quot;</span>, command ? command : <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_REPAINT;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; eBSP430cliConsole_REPAINT_BEL) {</div>
<div class="line">      <a class="code" href="console_8h.html#aa0572fcebf5d24edff00fc60c4563681">cputchar</a>(<span class="charliteral">&#39;\a&#39;</span>);</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_REPAINT_BEL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (flags &amp; eBSP430cliConsole_READY) {</div>
<div class="line">      <span class="comment">/* Clear the command we just completed */</span></div>
<div class="line">      <a class="code" href="group__grp__utility__cli__cli.html#ga15ac053830a35c1b1410fda48c0e7e3a">vBSP430cliConsoleBufferClear</a>();</div>
<div class="line">      flags &amp;= ~eBSP430cliConsole_READY;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">      <span class="comment">/* Discard any pending escape sequence */</span></div>
<div class="line">      flags = <a class="code" href="cli_8h.html#ab53c18df933fd6696f8d3e92795295f8">iBSP430cliConsoleBufferConsumeEscape</a>(flags);</div>
<div class="line">      <span class="comment">/* If no operations are pending, see if there is pending input. */</span></div>
<div class="line">      <span class="keywordflow">if</span> (0 == flags) {</div>
<div class="line">        flags = <a class="code" href="group__grp__utility__cli__cli.html#gaf192635722fef70abb4583a1c52a4e7a">iBSP430cliConsoleBufferProcessInput</a>();</div>
<div class="line">      }</div>
<div class="line">      <span class="comment">/* If still no operations pending wait for something to</span></div>
<div class="line"><span class="comment">       * happen. */</span></div>
<div class="line">      <span class="keywordflow">if</span> (0 == flags) {</div>
<div class="line">        <a class="code" href="core_8h.html#a1b153003ca93d41bd574dcd4790feb6d">BSP430_CORE_LPM_ENTER</a>(<a class="code" href="msp430_8h.html#a8af1e5b3633693d9439d284100183004">LPM2_bits</a>);</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">while</span> (! flags);</div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Got something to do; get the command contents in place so</span></div>
<div class="line"><span class="comment">     * we can update the screen. */</span></div>
<div class="line">    command = <a class="code" href="group__grp__utility__cli__cli.html#ga634626363e043b2a1efa7fb7b657ebe4">xBSP430cliConsoleBuffer</a>();</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="ex_rf_cc3000_config"></a>
bsp430_config.h</h1>
<div class="fragment"><div class="line"><span class="comment">/* Use a crystal if one is installed.  Much more accurate timing</span></div>
<div class="line"><span class="comment"> * results. */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_PLATFORM_BOOT_CONFIGURE_LFXT1 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Application does output: support spin-for-jumper */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_PLATFORM_SPIN_FOR_JUMPER 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Support console output */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_CONSOLE 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable an 8-character rx buffer for the console */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CONSOLE_RX_BUFFER_SIZE 8</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable an 80-character command buffer */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_CLI_CONSOLE_BUFFER_SIZE 80</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Enable completion */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_CLI_COMMAND_COMPLETION 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Monitor uptime and provide generic ACLK-driven timer */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_UPTIME 1</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Support for CC30000 BoosterPack.  This conflicts with RFEM use. */</span></div>
<div class="line"><span class="preprocessor">#ifndef configBSP430_RF_CC3000BOOST</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_RF_CC3000BOOST 0</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* configBSP430_RF_CC3000BOOST */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#if ! (configBSP430_RF_CC3000BOOST - 0)</span></div>
<div class="line"><span class="comment">/* Request RFEM interface resources specific to the CC3000EM.  NB:</span></div>
<div class="line"><span class="comment"> * CCEM maps SPI_IRQ to P6.5 on EXP430F5529LP; since that port is not</span></div>
<div class="line"><span class="comment"> * interrupt-enabled the CC3000 can&#39;t be used on that platform. */</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_RFEM_CCEM 1</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_RFEM 1</span></div>
<div class="line"><span class="preprocessor">#define configBSP430_RF_CC3000EM 1</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* RFEM */</span><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* Get platform defaults */</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="bsp430__config_8h.html">bsp430/platform/bsp430_config.h</a>&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* We use HAL for CSn, perhaps because it&#39;s a generic interface to the</span></div>
<div class="line"><span class="comment"> * DIR and OUT registers regardless of IE or non-IE register</span></div>
<div class="line"><span class="comment"> * layout. */</span></div>
<div class="line"><span class="preprocessor">#define BSP430_WANT_CONFIG_HAL 1</span></div>
<div class="line"><span class="preprocessor">#define BSP430_WANT_PERIPH_CPPID BSP430_RF_CC3000_CSn_PORT_PERIPH_CPPID</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="want___8h.html">bsp430/periph/want_.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#undef BSP430_WANT_CONFIG_HAL</span></div>
</div><!-- fragment --><h1><a class="anchor" id="ex_rf_cc3000_make"></a>
Makefile</h1>
<div class="fragment"><div class="line">PLATFORM ?= exp430f5438</div>
<div class="line">TEST_PLATFORMS=exp430f5438 trxeb</div>
<div class="line">MODULES=$(MODULES_PLATFORM)</div>
<div class="line">MODULES += $(MODULES_UPTIME)</div>
<div class="line">MODULES += $(MODULES_CONSOLE)</div>
<div class="line">MODULES += periph/port</div>
<div class="line">MODULES += periph/sys</div>
<div class="line">MODULES += periph/flash</div>
<div class="line">MODULES += utility/cli</div>
<div class="line"></div>
<div class="line"># Add the rules to provide external library support for the CC3000</div>
<div class="line">include $(BSP430_ROOT)/make/Makefile.cc3000</div>
<div class="line"></div>
<div class="line"># Optionally enable the nvmem update infrastructure.</div>
<div class="line"># This requires the presence of two files:</div>
<div class="line">#  wlan_drv_patch.inc   # has patches to the CC3000 driver</div>
<div class="line">#  fw_patch.inc         # has patches to the CC3000 firmware</div>
<div class="line"># See the source for information on where to get these files.</div>
<div class="line"># You may need to disable other commands to make room for</div>
<div class="line"># these, or build with 20-bit support.</div>
<div class="line">WITH_UPDATE ?=</div>
<div class="line">ifneq (,$(WITH_UPDATE))</div>
<div class="line">AUX_CPPFLAGS += -DWITH_UPDATE</div>
<div class="line">endif # WITH_UPDATE</div>
<div class="line"></div>
<div class="line"># Optionally enable radio module comparison</div>
<div class="line"># This requires the presence of the following file:</div>
<div class="line">#  rm_param.inc         # has radio module default parameters</div>
<div class="line"># See the source for information on where to get these files.</div>
<div class="line">WITH_RMPARAM ?=</div>
<div class="line">ifneq (,$(WITH_RMPARAM))</div>
<div class="line">AUX_CPPFLAGS += -DWITH_RMPARAM</div>
<div class="line">endif # WITH_RMPARAM</div>
<div class="line"></div>
<div class="line"># Optionally enable SmartConfig.</div>
<div class="line">WITH_SMART ?=</div>
<div class="line">ifneq (,$(WITH_SMART))</div>
<div class="line">AUX_CPPFLAGS += -DBSP430_CC3000_ENABLE_SMART</div>
<div class="line">endif # WITH_SMART</div>
<div class="line"></div>
<div class="line"># Optionally read profiles from local file</div>
<div class="line">WITH_PROFILES ?=</div>
<div class="line">ifneq (,$(WITH_PROFILES))</div>
<div class="line">AUX_CPPFLAGS += -DWITH_PROFILES</div>
<div class="line">endif # WITH_PROFILES</div>
<div class="line"></div>
<div class="line">SRC += main.c</div>
<div class="line">include $(BSP430_ROOT)/make/Makefile.common</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Nov 15 2014 11:27:13 for BSP430 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
