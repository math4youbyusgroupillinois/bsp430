<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>BSP430: Using the GNU msp430-elf Compiler System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BSP430
   &#160;<span id="projectnumber">20141115</span>
   </div>
   <div id="projectbrief">Board Support Package for MSP430 microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Using the GNU msp430-elf Compiler System </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#msp430elf_building">How to Build the Toolchain</a></li>
<li class="level1"><a href="#msp430elf_ld">Overriding Linker Scripts</a><ul><li class="level2"><a href="#msp430elf_ld_far">20-Bit Support</a></li>
</ul>
</li>
<li class="level1"><a href="#msp430elf_newlib">C Library Support</a><ul><li class="level2"><a href="#msp430elf_newlib_sys">System Interface</a><ul><li class="level3"><a href="#msp430elf_newlib_sys_sbrk">Dynamic Memory Management</a></li>
<li class="level3"><a href="#msp430elf_newlib_sys_printf">Formatted Input/Output</a></li>
<li class="level3"><a href="#msp430elf_newlib_sys_fdops_stdio">Standard I/O Descriptors</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>BSP430 was initially developed using the <a href="http://sourceforge.net/projects/mspgcc/">MSPGCC</a> toolchain, a port of the GNU compiler collection to the MSP430 that was begun by Dmitry Diky and Chris Liechti in 2001. Because copyright assignments could not be obtained from some past contributors this port could not be integrated by GNU so in 2012 TI funded Red Hat to create a new back-end for the MSP430.</p>
<p>In late 2014 this port reached maturity, and is now fully supported by BSP430. It is selected by setting <code>WITH_GCC_MSP430_ELF=1</code> in the environment or passed through as an option to <code>make</code>. In a future release this toolchain will become the default, with MSPGCC available as an alternative using <code>WITH_GCC_MSPGCC=1</code>. (To disable a selected toolchain use <code>WITH_GCC_MSP430_ELF=</code> leaving an empty string as the value.)</p>
<h1><a class="anchor" id="msp430elf_building"></a>
How to Build the Toolchain</h1>
<p>Texas Instruments provides a <a href="http://www.ti.com/tool/msp430-gcc-opensource">vendor-supported fork of the GCC compiler</a> but BSP430 is developed using the fully open source release as built from the upstream repositories.</p>
<p>The script <a href="https://github.com/pabigot/bsp430/blob/next/maintainer/msp430-elf-build"><code>maintainer/msp430-elf</code></a> provided in BSP430 can be used to do the build. It assumes you have updated workspaces for the required packages already cloned onto your system:</p>
<ul>
<li>binutils at git://sourceware.org/git/binutils-gdb.git </li>
<li>gcc at git://gcc.gnu.org/git/gcc.git </li>
<li>newlib at git://sourceware.org/git/newlib.git </li>
<li>git://github.com/pabigot/msp430-elf.git</li>
</ul>
<p>The development trunk of each project should always work, but the versions listed in <a class="el" href="releases.html">Release Notes and API Changes</a> have been tested.</p>
<dl class="section note"><dt>Note</dt><dd>Please do not ask the BSP430 maintainer for help with toolchain building. If you are uncomfortable building a compiler toolchain, look to TI or your OS vendor for packaged releases.</dd></dl>
<h1><a class="anchor" id="msp430elf_ld"></a>
Overriding Linker Scripts</h1>
<p>By default the linker script provided by the <a href="https://github.com/pabigot/msp430-elf">TI device bundle</a> is used. BSP430 allows you to override this by defining an alternative with the <code>LDSCRIPT</code> Make variable. See <code>make/Makefile.common</code> for details.</p>
<h2><a class="anchor" id="msp430elf_ld_far"></a>
20-Bit Support</h2>
<p>Large memory model is specified by adding <code>MEMORY_MODEL=large</code> to the <code>make</code> options. This changes the default <code>LDSCRIPT</code> value, since the TI-provided ones do not currently include sections placed in far memory.</p>
<p>Due to limitations in the msp430-elf linker, it is only possible to place either read-only data or code above the 64 kiB boundary. By default code is placed in high memory, but if read-only data is large it can be placed there by using <code>LDSCRIPT_LARGE_SUFFIX=far-rodata</code>.</p>
<h1><a class="anchor" id="msp430elf_newlib"></a>
C Library Support</h1>
<p><a href="https://sourceware.org/newlib/">Newlib</a> is an open-source implementation of the standard C library, and is used as the libc implementation in BSPACM's primary toolchain, <a href="https://launchpad.net/gcc-arm-embedded">GNU Tools for ARM Embedded Processors</a>. It was designed for use in embedded systems, using a small set of externally-supplied functions to interface with the system.</p>
<p>While newlib is still too large for the smallest MSP430 processors, the efforts of the <a href="https://launchpad.net/gcc-arm-embedded">GNU for ARM Embedded</a> folks to create "newlib-nano" are slowly being integrated into newlib, and as of late 2014 there are options that allow it to be small enough to work on most MSP430 processors.</p>
<p>The default build options suggested by <code>maintainer/msp430-elf-build</code> result in the following issues:</p>
<ul>
<li>No support for <code>uint64_t</code> format specifiers (e.g. PRIx64 from &lt;inttypes.h&gt;</li>
</ul>
<ul>
<li>stdio buffering is disabled by default for descriptors other than stdin/stdout/stderr.</li>
</ul>
<h2><a class="anchor" id="msp430elf_newlib_sys"></a>
System Interface</h2>
<p>newlib expects each target to provide an implementation of certain low-level functions to interact with the system environment. If nothing provides an implementation of one of these functions (e.g., <code>write()</code>) but the application requires one, the application will fail to link. The following symbols are referenced by the msp430 newlib infrastructure:</p>
<p><a class="anchor" id="msp430elf_newlib_sys_weak_misc"></a></p><div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keywordtype">char</span> ** environ;</div>
<div class="line"><span class="keywordtype">int</span> _chown (<span class="keyword">const</span> <span class="keywordtype">char</span> * path, uid_t owner, gid_t group);</div>
<div class="line"><span class="keywordtype">int</span> close (<span class="keywordtype">int</span> fd);</div>
<div class="line"><span class="keywordtype">int</span> execve (<span class="keyword">const</span> <span class="keywordtype">char</span> * filename, <span class="keywordtype">char</span> * <span class="keyword">const</span> argv[], <span class="keywordtype">char</span> * <span class="keyword">const</span> envp[]);</div>
<div class="line">pid_t fork (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">int</span> fstat (<span class="keywordtype">int</span> fd, <span class="keyword">struct</span> stat * buf);</div>
<div class="line">pid_t getpid (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">int</span> gettimeofday (<span class="keyword">struct</span> timeval * tv, <span class="keyword">struct</span> timezone * tz);</div>
<div class="line"><span class="keywordtype">int</span> isatty (<span class="keywordtype">int</span> fd);</div>
<div class="line"><span class="keywordtype">int</span> kill (pid_t pid, <span class="keywordtype">int</span> sig);</div>
<div class="line"><span class="keywordtype">int</span> link (<span class="keyword">const</span> <span class="keywordtype">char</span> * oldpath, <span class="keyword">const</span> <span class="keywordtype">char</span> * newpath);</div>
<div class="line">off_t lseek (<span class="keywordtype">int</span> fd, off_t offset, <span class="keywordtype">int</span> whence);</div>
<div class="line"><span class="keywordtype">int</span> open (<span class="keyword">const</span> <span class="keywordtype">char</span> * pathname, <span class="keywordtype">int</span> flags);</div>
<div class="line">_READ_WRITE_RETURN_TYPE read (<span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> * buf, <span class="keywordtype">size_t</span> count);</div>
<div class="line">ssize_t _readlink (<span class="keyword">const</span> <span class="keywordtype">char</span> * path, <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> bufsiz);</div>
<div class="line"><span class="keywordtype">void</span> * <a class="code" href="system_8h.html#a3b818446c640442e94e746319f5f2858">sbrk</a> (ptrdiff_t increment);</div>
<div class="line"><span class="keywordtype">int</span> stat (<span class="keyword">const</span> <span class="keywordtype">char</span> * path, <span class="keyword">struct</span> stat * buf);</div>
<div class="line"><span class="keywordtype">int</span> _symlink (<span class="keyword">const</span> <span class="keywordtype">char</span> * oldpath, <span class="keyword">const</span> <span class="keywordtype">char</span> * newpath);</div>
<div class="line">clock_t times (<span class="keyword">struct</span> tms *buf);</div>
<div class="line"><span class="keywordtype">int</span> unlink (<span class="keyword">const</span> <span class="keywordtype">char</span> * pathname);</div>
<div class="line">pid_t wait (<span class="keywordtype">int</span> * status);</div>
<div class="line">_READ_WRITE_RETURN_TYPE write (<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">void</span> * buf, <span class="keywordtype">size_t</span> count);</div>
<div class="line"><span class="keywordtype">void</span> _exit (<span class="keywordtype">int</span> status);</div>
</div><!-- fragment --><p>BSP430's <code>Makefile.common</code> uses the <code>NEWLIB_SYS</code> variable to identify the provider of these functions. The default is to use <code>newlib/nosys.c</code> which provides weak definitions for each required function.</p>
<p>Most of the weak definitions simply return an error code.</p>
<h3><a class="anchor" id="msp430elf_newlib_sys_sbrk"></a>
Dynamic Memory Management</h3>
<p>BSP430 provides a function <code><a class="el" href="system_8h.html#a3b818446c640442e94e746319f5f2858">sbrk()</a></code> which controls dynamic memory allocation, with several implementations in <code>newlib/sbrk.c</code> with the default being to dynamically allocate memory between static allocations and the bottom of the stack. See &lt;<a class="el" href="system_8h.html" title="Prototypes for BSP430 system enhancements to newlib. ">bsp430/newlib/system.h</a>&gt; for details on these options and how to override them.</p>
<p>A highlight of this implementation is that if dynamic allocation fails the system will invoke an <a class="el" href="system_8h.html#ac2b45777c26a5f32e48aefba5d00c1e4">_bsp430_sbrk_error()</a> allowing the application to recover appropriately. The default implementation of that function spins in place with interrupts disabled, allowing a debugger to inspect the call stack to locate the problematic allocation.</p>
<h3><a class="anchor" id="msp430elf_newlib_sys_printf"></a>
Formatted Input/Output</h3>
<p>MSPGCC used a custom libc implementation that was highly optimized to reduce code space. Support for formatted output is particularly bloated in many other libc implementations, resulting in a fork of msp430-libc's version into <a href="http://pabigot.github.com/embtextf/">embtextf</a>.</p>
<p>With the "nano" options selected newlib for MSP430 is competitive with embtextf; a basic check showed that overriding newlib's routines with embtextf for formatted output reduced code size and data size by about 350 bytes each. However, newlib's <code>printf</code> will attempt to dynamically allocate memory for buffers which an introduce problems on very small devices.</p>
<p>newlib also assumes that descriptors for stdin (0), stdout (1), and stderr(2) are provided by the system and are supported by provided definitions of read() and write(). When <a class="el" href="console_8h.html#a7e7be9a93cd9726e38378c1736d3b239">console support</a> is enabled BSP430 supports this by ensuring that read() and write() are overridden to use the console UART.</p>
<h3><a class="anchor" id="msp430elf_newlib_sys_fdops_stdio"></a>
Standard I/O Descriptors</h3>
<p>At this time BSP430 provides no infrastructure for generalized file descriptor operations. Should this ever change, the <a href="http://pabigot.github.io/bspacm/newlib.html#newlib_sys_fdops">techniques used by BSPACM are likely to be ported to BSP430. Copyright 2012-2014, Peter A. Bigot </a></p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Nov 15 2014 11:27:13 for BSP430 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
